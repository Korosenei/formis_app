{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block page_title %}{{ evaluation.titre }} - Détails{% endblock %}

{% block content %}
<div class="evaluation-detail-teacher">
    <!-- Header -->
    <div class="detail-header">
        <div class="header-content">
            <div class="breadcrumb-nav">
                <a href="{% url 'evaluations:list_enseignant' %}">Évaluations</a>
                <i class="fas fa-chevron-right"></i>
                <span class="current">{{ evaluation.titre }}</span>
            </div>
            <div class="header-title">
                <h1>{{ evaluation.titre }}</h1>
                <div class="header-badges">
                    <span class="type-badge {{ evaluation.type_evaluation|lower }}">{{ evaluation.get_type_evaluation_display }}</span>
                    <span class="status-badge {{ evaluation.statut|lower }}">{{ evaluation.get_statut_display }}</span>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <a href="{% url 'evaluations:evaluation_edit' evaluation.id %}" class="btn btn-sm btn-primary">
                <i class="fas fa-edit"></i> Modifier
            </a>
            <button class="btn btn-sm btn-success" onclick="publierCorrection({{ evaluation.id }})">
                <i class="fas fa-upload"></i> Publier correction
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ stats.total_apprenants }}</div>
                <div class="stat-label">Apprenants concernés</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-paper-plane"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ stats.soumises }}</div>
                <div class="stat-label">Compositions soumises</div>
                <div class="stat-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ stats.taux_soumission }}%"></div>
                    </div>
                    <span class="progress-text">{{ stats.taux_soumission|floatformat:1 }}%</span>
                </div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ stats.corrigees }}</div>
                <div class="stat-label">Compositions corrigées</div>
                <div class="stat-progress">
                    <div class="progress-bar">
                        <div class="progress-fill success" style="width: {{ stats.taux_correction }}%"></div>
                    </div>
                    <span class="progress-text">{{ stats.taux_correction|floatformat:1 }}%</span>
                </div>
            </div>
        </div>
        {% if notes_stats %}
        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ notes_stats.moyenne|floatformat:2 }}</div>
                <div class="stat-label">Moyenne de classe</div>
                <small class="stat-range">Min: {{ notes_stats.min }} | Max: {{ notes_stats.max }}</small>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Informations principales -->
    <div class="detail-grid">
        <div class="detail-section">
            <div class="section-header">
                <h3><i class="fas fa-info-circle"></i> Informations</h3>
            </div>
            <div class="section-content">
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-book"></i> Matière</span>
                    <span class="info-value">{{ evaluation.matiere.nom }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-calculator"></i> Coefficient</span>
                    <span class="info-value">{{ evaluation.coefficient }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-star"></i> Note maximale</span>
                    <span class="info-value">{{ evaluation.note_maximale }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-calendar"></i> Début</span>
                    <span class="info-value">{{ evaluation.date_debut|date:"d/m/Y à H:i" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-calendar-check"></i> Fin</span>
                    <span class="info-value">{{ evaluation.date_fin|date:"d/m/Y à H:i" }}</span>
                </div>
                {% if evaluation.duree_minutes %}
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-clock"></i> Durée</span>
                    <span class="info-value">{{ evaluation.duree_minutes }} min</span>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="detail-section">
            <div class="section-header">
                <h3><i class="fas fa-users"></i> Classes concernées</h3>
            </div>
            <div class="section-content">
                <div class="classes-list">
                    {% for classe in evaluation.classes.all %}
                        <div class="classe-badge">
                            <i class="fas fa-door-open"></i>
                            {{ classe.nom }}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    {% if evaluation.description %}
    <div class="detail-section">
        <div class="section-header">
            <h3><i class="fas fa-align-left"></i> Description</h3>
        </div>
        <div class="section-content">
            <p>{{ evaluation.description }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Fichiers -->
    <div class="detail-section">
        <div class="section-header">
            <h3><i class="fas fa-file-pdf"></i> Documents</h3>
        </div>
        <div class="section-content">
            <div class="files-grid">
                {% if evaluation.fichier_evaluation %}
                <div class="file-card">
                    <div class="file-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">Sujet de l'évaluation</div>
                        <div class="file-actions">
                            <a href="{% url 'evaluations:voir_fichier' 'evaluation' evaluation.id %}"
                               class="btn-link" target="_blank">
                                <i class="fas fa-eye"></i> Voir
                            </a>
                            <a href="{% url 'evaluations:telecharger_evaluation' evaluation.id %}"
                               class="btn-link">
                                <i class="fas fa-download"></i> Télécharger
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if evaluation.fichier_correction %}
                <div class="file-card">
                    <div class="file-icon correction">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">Correction</div>
                        <div class="file-actions">
                            <a href="{% url 'evaluations:voir_fichier' 'correction' evaluation.id %}"
                               class="btn-link" target="_blank">
                                <i class="fas fa-eye"></i> Voir
                            </a>
                            <a href="{% url 'evaluations:telecharger_fichier_correction' evaluation.id %}"
                               class="btn-link">
                                <i class="fas fa-download"></i> Télécharger
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if not evaluation.fichier_evaluation and not evaluation.fichier_correction %}
                <div class="empty-state-small">
                    <i class="fas fa-folder-open"></i>
                    <p>Aucun document disponible</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Liste des compositions -->
    <div class="detail-section">
        <div class="section-header">
            <h3><i class="fas fa-list"></i> Compositions ({{ compositions.count }})</h3>
            <div class="section-actions">
                <a href="{% url 'evaluations:correction_en_masse' evaluation.id %}" class="btn-link">
                    <i class="fas fa-tasks"></i> Correction en masse
                </a>
            </div>
        </div>
        <div class="section-content">
            {% if compositions %}
            <div class="table-wrapper">
                <table class="compositions-table">
                    <thead>
                        <tr>
                            <th>Apprenant</th>
                            <th>Date soumission</th>
                            <th>Statut</th>
                            <th>Note</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for composition in compositions %}
                        <tr>
                            <td>
                                <div class="apprenant-info">
                                    <strong>{{ composition.apprenant.get_full_name }}</strong>
                                    <small>{{ composition.apprenant.matricule }}</small>
                                </div>
                            </td>
                            <td>
                                {% if composition.date_soumission %}
                                    {{ composition.date_soumission|date:"d/m/Y H:i" }}
                                    {% if composition.est_en_retard %}
                                        <span class="badge badge-warning">Retard</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">Non soumis</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge {{ composition.statut|lower }}">
                                    {{ composition.get_statut_display }}
                                </span>
                            </td>
                            <td>
                                {% if composition.note_obtenue %}
                                    <strong>{{ composition.note_obtenue }}</strong>/{{ evaluation.note_maximale }}
                                    {% if composition.note_avec_penalite != composition.note_obtenue %}
                                        <small class="text-warning">({{ composition.note_avec_penalite }} après pénalité)</small>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    {% if composition.statut in 'SOUMISE,EN_RETARD' %}
                                        <a href="{% url 'evaluations:corriger_composition' composition.id %}"
                                           class="btn-icon-sm btn-success" title="Corriger">
                                            <i class="fas fa-check"></i>
                                        </a>
                                    {% elif composition.statut == 'CORRIGEE' %}
                                        <a href="{% url 'evaluations:corriger_composition' composition.id %}"
                                           class="btn-icon-sm btn-info" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    {% endif %}
                                    {% if composition.fichiers_composition.exists %}
                                        <button class="btn-icon-sm btn-primary"
                                                onclick="voirFichiers({{ composition.id }})"
                                                title="Voir fichiers">
                                            <i class="fas fa-file"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state-small">
                <i class="fas fa-clipboard"></i>
                <p>Aucune composition pour le moment</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Fichiers -->
<div id="fichiersModal" class="modal">
    <div class="modal-content modal-md">
        <div class="modal-header">
            <h3>Fichiers de la composition</h3>
            <button class="modal-close" onclick="closeFichiersModal()">&times;</button>
        </div>
        <div class="modal-body" id="fichiersModalBody">
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>
        </div>
    </div>
</div>

<style>
.evaluation-detail-teacher { padding: 15px; max-width: 1400px; margin: 0 auto; }
.detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.breadcrumb-nav { font-size: 12px; color: #6b7280; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
.breadcrumb-nav a { color: #2563eb; text-decoration: none; }
.breadcrumb-nav .current { color: #1f2937; font-weight: 500; }
.header-title { display: flex; flex-direction: column; gap: 8px; }
.header-title h1 { margin: 0; font-size: 24px; font-weight: 600; color: #1f2937; }
.header-badges { display: flex; gap: 8px; }
.type-badge, .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; }
.type-badge.devoir { background: #e3f2fd; color: #1976d2; }
.type-badge.composition { background: #f3e5f5; color: #7b1fa2; }
.type-badge.tp { background: #e8f5e9; color: #388e3c; }
.type-badge.examen { background: #ffebee; color: #c62828; }
.status-badge.brouillon { background: #e0e0e0; color: #616161; }
.status-badge.programmee { background: #fff3cd; color: #856404; }
.status-badge.en_cours { background: #d1ecf1; color: #0c5460; }
.status-badge.terminee { background: #d4edda; color: #155724; }
.header-actions { display: flex; gap: 8px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
.stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; }
.stat-icon { width: 48px; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; }
.stat-icon.blue { background: #2563eb; }
.stat-icon.green { background: #10b981; }
.stat-icon.orange { background: #f59e0b; }
.stat-icon.purple { background: #8b5cf6; }
.stat-content { flex: 1; }
.stat-value { font-size: 28px; font-weight: 700; color: #1f2937; }
.stat-label { font-size: 13px; color: #6b7280; margin-bottom: 5px; }
.stat-progress { margin-top: 5px; }
.progress-bar { height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; background: #2563eb; transition: width 0.3s; }
.progress-fill.success { background: #10b981; }
.progress-text { font-size: 11px; color: #6b7280; margin-left: 5px; }
.stat-range { font-size: 11px; color: #6b7280; }
.detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; }
.detail-section { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
.section-header { padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
.section-header h3 { margin: 0; font-size: 16px; font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 8px; }
.section-content { padding: 15px; }
.info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
.info-row:last-child { border-bottom: none; }
.info-label { font-size: 13px; color: #6b7280; display: flex; align-items: center; gap: 8px; }
.info-value { font-size: 13px; color: #1f2937; font-weight: 500; }
.classes-list { display: flex; flex-wrap: wrap; gap: 8px; }
.classe-badge { padding: 6px 12px; background: #f3f4f6; border-radius: 6px; font-size: 12px; color: #1f2937; display: flex; align-items: center; gap: 6px; }
.files-grid { display: grid; gap: 12px; }
.file-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; }
.file-icon { width: 40px; height: 40px; background: #ef4444; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
.file-icon.correction { background: #10b981; }
.file-info { flex: 1; }
.file-name { font-weight: 600; font-size: 14px; color: #1f2937; margin-bottom: 4px; }
.file-actions { display: flex; gap: 12px; }
.btn-link { font-size: 12px; color: #2563eb; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; }
.btn-link:hover { text-decoration: underline; }
.table-wrapper { overflow-x: auto; }
.compositions-table { width: 100%; border-collapse: collapse; }
.compositions-table th { background: #f9fafb; padding: 10px; text-align: left; font-weight: 600; font-size: 12px; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
.compositions-table td { padding: 12px 10px; border-bottom: 1px solid #e5e7eb; font-size: 13px; }
.apprenant-info { display: flex; flex-direction: column; gap: 2px; }
.apprenant-info strong { font-size: 13px; color: #1f2937; }
.apprenant-info small { font-size: 11px; color: #6b7280; }
.action-buttons { display: flex; gap: 5px; }
.btn-icon-sm { width: 28px; height: 28px; border-radius: 4px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 11px; }
.btn-icon-sm.btn-success { background: #10b981; color: white; }
.btn-icon-sm.btn-info { background: #3b82f6; color: white; }
.btn-icon-sm.btn-primary { background: #2563eb; color: white; }
.btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; }
.btn-sm { padding: 5px 10px; font-size: 11px; }
.btn-primary { background: #2563eb; color: white; }
.btn-success { background: #10b981; color: white; }
.empty-state-small { text-align: center; padding: 30px; color: #6b7280; }
.empty-state-small i { font-size: 32px; margin-bottom: 10px; opacity: 0.5; }
.text-muted { color: #6b7280; }
.text-warning { color: #f59e0b; }
.badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 500; }
.badge-warning { background: #fef3c7; color: #92400e; }
.badge-info { background: #dbeafe; color: #1e40af; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
.modal.show { display: flex; }
.modal-content { background: white; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
.modal-header { padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
.modal-header h3 { margin: 0; font-size: 18px; }
.modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
.modal-body { padding: 20px; }
</style>

<script>
function publierCorrection(evalId) {
    if (confirm('Publier la correction maintenant ?')) {
        alert('Fonctionnalité à implémenter');
    }
}

function voirFichiers(compositionId) {
    document.getElementById('fichiersModal').classList.add('show');
    // À implémenter: charger les fichiers via AJAX
}

function closeFichiersModal() {
    document.getElementById('fichiersModal').classList.remove('show');
}
</script>
{% endblock %}