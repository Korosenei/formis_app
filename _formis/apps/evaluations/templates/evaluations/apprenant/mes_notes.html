{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block page_title %}Mes Notes et Résultats{% endblock %}

{% block content %}
<div class="student-notes">
    <!-- Header avec moyenne générale -->
    <div class="notes-header">
        <div class="header-content">
            <h1>Mes Notes et Résultats</h1>
            <p class="subtitle">Suivi de ma progression académique</p>
        </div>
        <div class="moyenne-generale-card">
            <div class="moyenne-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="moyenne-content">
                <div class="moyenne-label">Moyenne Générale</div>
                <div class="moyenne-value">{{ moyenne_generale }}<span>/20</span></div>
                <div class="moyenne-appreciation">
                    {% if moyenne_generale >= 16 %}
                        <span class="appreciation excellent">Excellent</span>
                    {% elif moyenne_generale >= 14 %}
                        <span class="appreciation tres-bien">Très bien</span>
                    {% elif moyenne_generale >= 12 %}
                        <span class="appreciation bien">Bien</span>
                    {% elif moyenne_generale >= 10 %}
                        <span class="appreciation passable">Passable</span>
                    {% else %}
                        <span class="appreciation insuffisant">Insuffisant</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Moyennes par matière -->
    <div class="matieres-section">
        <div class="section-header">
            <h2><i class="fas fa-book"></i> Moyennes par matière</h2>
        </div>
        <div class="matieres-grid">
            {% for moyenne_data in moyennes_matieres %}
            <div class="matiere-card">
                <div class="matiere-header">
                    <div class="matiere-color" style="background-color: {{ moyenne_data.matiere.couleur }}"></div>
                    <div class="matiere-info">
                        <h3>{{ moyenne_data.matiere.nom }}</h3>
                        <div class="matiere-meta">
                            <span><i class="fas fa-calculator"></i> Coef. {{ moyenne_data.matiere.coefficient }}</span>
                            <span><i class="fas fa-clipboard-list"></i> {{ moyenne_data.notes|length }} note(s)</span>
                        </div>
                    </div>
                </div>
                <div class="matiere-moyenne">
                    <div class="moyenne-circle">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <path class="circle" stroke-dasharray="{{ moyenne_data.moyenne|floatformat:0|add:'5' }}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            <text x="18" y="20.35" class="percentage">{{ moyenne_data.moyenne|floatformat:1 }}</text>
                        </svg>
                    </div>
                    <div class="moyenne-detail">
                        <div class="moyenne-note">{{ moyenne_data.moyenne|floatformat:2 }}/20</div>
                    </div>
                </div>
                <div class="matiere-actions">
                    <button class="btn-text" onclick="showNotesMa tiere({{ moyenne_data.matiere.id }})">
                        <i class="fas fa-eye"></i> Voir le détail
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-clipboard"></i>
                <p>Aucune note disponible pour le moment</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Liste détaillée des notes -->
    <div class="notes-section">
        <div class="section-header">
            <h2><i class="fas fa-list"></i> Toutes mes notes</h2>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Toutes</button>
                <button class="filter-btn" data-filter="recent">Récentes</button>
                <button class="filter-btn" data-filter="best">Meilleures</button>
            </div>
        </div>
        <div class="notes-table-container">
            <table class="notes-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Matière</th>
                        <th>Évaluation</th>
                        <th>Type</th>
                        <th>Coef.</th>
                        <th>Note</th>
                        <th>Note/20</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for note in notes %}
                    <tr class="note-row">
                        <td>{{ note.date_attribution|date:"d/m/Y" }}</td>
                        <td>
                            <div class="matiere-cell">
                                <div class="matiere-dot" style="background-color: {{ note.matiere.couleur }}"></div>
                                {{ note.matiere.nom }}
                            </div>
                        </td>
                        <td>
                            <strong>{{ note.evaluation.titre }}</strong>
                        </td>
                        <td>
                            <span class="type-badge {{ note.evaluation.type_evaluation|lower }}">
                                {{ note.evaluation.get_type_evaluation_display }}
                            </span>
                        </td>
                        <td class="text-center">{{ note.coefficient_pondere }}</td>
                        <td class="text-center">
                            <span class="note-value {% if note.valeur >= note.note_sur|multiply:0.7 %}success{% elif note.valeur >= note.note_sur|multiply:0.5 %}warning{% else %}danger{% endif %}">
                                {{ note.valeur }}/{{ note.note_sur }}
                            </span>
                        </td>
                        <td class="text-center">
                            <strong>{{ note.note_sur_20|floatformat:2 }}</strong>
                        </td>
                        <td>
                            <a href="{% url 'evaluations:detail_apprenant' note.evaluation.id %}"
                               class="btn-icon-sm btn-primary" title="Voir détail">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="empty-cell">
                            <div class="empty-state-small">
                                <i class="fas fa-clipboard"></i>
                                <p>Aucune note disponible</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.student-notes { padding: 15px; max-width: 1400px; margin: 0 auto; }
.notes-header { display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 30px; align-items: center; }
.header-content h1 { margin: 0 0 5px 0; font-size: 28px; font-weight: 700; color: #1f2937; }
.subtitle { margin: 0; font-size: 14px; color: #6b7280; }
.moyenne-generale-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); display: flex; gap: 20px; align-items: center; min-width: 280px; }
.moyenne-icon { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
.moyenne-label { font-size: 12px; opacity: 0.9; margin-bottom: 5px; }
.moyenne-value { font-size: 42px; font-weight: 700; line-height: 1; }
.moyenne-value span { font-size: 24px; opacity: 0.8; }
.moyenne-appreciation { margin-top: 8px; }
.appreciation { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(255,255,255,0.2); }
.matieres-section { margin-bottom: 30px; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.section-header h2 { margin: 0; font-size: 18px; font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 10px; }
.matieres-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
.matiere-card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
.matiere-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.matiere-header { padding: 20px; display: flex; gap: 12px; border-bottom: 1px solid #e5e7eb; }
.matiere-color { width: 4px; height: 60px; border-radius: 2px; }
.matiere-info h3 { margin: 0 0 8px 0; font-size: 16px; font-weight: 600; color: #1f2937; }
.matiere-meta { display: flex; gap: 12px; font-size: 11px; color: #6b7280; }
.matiere-meta span { display: flex; align-items: center; gap: 4px; }
.matiere-moyenne { padding: 20px; display: flex; align-items: center; gap: 20px; }
.moyenne-circle { width: 80px; height: 80px; }
.circular-chart { display: block; max-width: 100%; max-height: 100%; }
.circle-bg { fill: none; stroke: #e5e7eb; stroke-width: 3.8; }
.circle { fill: none; stroke: #10b981; stroke-width: 2.8; stroke-linecap: round; animation: progress 1s ease-out forwards; }
@keyframes progress { from { stroke-dasharray: 0 100; } }
.percentage { fill: #1f2937; font-size: 8px; font-weight: 600; text-anchor: middle; }
.moyenne-note { font-size: 24px; font-weight: 700; color: #1f2937; }
.matiere-actions { padding: 15px 20px; background: #f9fafb; }
.btn-text { background: none; border: none; color: #2563eb; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; }
.btn-text:hover { text-decoration: underline; }
.filter-buttons { display: flex; gap: 8px; }
.filter-btn { padding: 6px 14px; border: 1px solid #e5e7eb; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; color: #6b7280; transition: all 0.2s; }
.filter-btn:hover { border-color: #2563eb; color: #2563eb; }
.filter-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
.notes-table-container { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
.notes-table { width: 100%; border-collapse: collapse; }
.notes-table th { background: #f9fafb; padding: 12px; text-align: left; font-weight: 600; font-size: 12px; color: #6b7280; border-bottom: 2px solid #e5e7eb; }
.notes-table td { padding: 14px 12px; border-bottom: 1px solid #e5e7eb; font-size: 13px; color: #1f2937; }
.notes-table tbody tr:hover { background: #f9fafb; }
.matiere-cell { display: flex; align-items: center; gap: 8px; }
.matiere-dot { width: 8px; height: 8px; border-radius: 50%; }
.type-badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 500; }
.type-badge.devoir { background: #e3f2fd; color: #1976d2; }
.type-badge.composition { background: #f3e5f5; color: #7b1fa2; }
.type-badge.tp { background: #e8f5e9; color: #388e3c; }
.type-badge.examen { background: #ffebee; color: #c62828; }
.text-center { text-align: center; }
.note-value { padding: 4px 10px; border-radius: 12px; font-weight: 600; font-size: 14px; }
.note-value.success { background: #d1fae5; color: #065f46; }
.note-value.warning { background: #fef3c7; color: #92400e; }
.note-value.danger { background: #fee2e2; color: #991b1b; }
.btn-icon-sm { width: 28px; height: 28px; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 11px; }
.btn-icon-sm.btn-primary { background: #2563eb; color: white; }
.empty-state, .empty-state-small { text-align: center; padding: 40px 20px; color: #6b7280; }
.empty-state i, .empty-state-small i { font-size: 48px; opacity: 0.5; margin-bottom: 15px; display: block; }
.empty-cell { padding: 40px; }

@media (max-width: 968px) {
    .notes-header { grid-template-columns: 1fr; }
    .moyenne-generale-card { min-width: auto; }
    .matieres-grid { grid-template-columns: 1fr; }
    .notes-table-container { overflow-x: auto; }
    .notes-table { min-width: 800px; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterBtns = document.querySelectorAll('.filter-btn');
    const rows = document.querySelectorAll('.note-row');

    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const filter = this.dataset.filter;

            if (filter === 'all') {
                rows.forEach(row => row.style.display = '');
            } else if (filter === 'recent') {
                // Afficher les 5 dernières notes
                rows.forEach((row, index) => {
                    row.style.display = index < 5 ? '' : 'none';
                });
            } else if (filter === 'best') {
                // Trier et afficher les meilleures notes
                const sortedRows = Array.from(rows).sort((a, b) => {
                    const noteA = parseFloat(a.querySelector('.note-value').textContent.split('/')[0]);
                    const noteB = parseFloat(b.querySelector('.note-value').textContent.split('/')[0]);
                    return noteB - noteA;
                });

                rows.forEach(row => row.style.display = 'none');
                sortedRows.slice(0, 10).forEach(row => row.style.display = '');
            }
        });
    });
});

function showNotesMatiere(matiereId) {
    // Filtrer le tableau pour afficher uniquement les notes de cette matière
    const rows = document.querySelectorAll('.note-row');
    rows.forEach(row => {
        const matiereDot = row.querySelector('.matiere-dot');
        // Logique de filtrage à implémenter
    });

    // Scroll vers le tableau
    document.querySelector('.notes-section').scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}