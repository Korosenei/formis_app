{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block page_title %}Mes Évaluations - FORMIS{% endblock %}

{% block extra_css %}
<style>
  .evaluation-card {
    border: 1px solid #dee2e6;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background: white;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .evaluation-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: #dee2e6;
  }

  .evaluation-card.active::before { background: #28a745; }
  .evaluation-card.terminee::before { background: #6c757d; }
  .evaluation-card.programmee::before { background: #17a2b8; }
  .evaluation-card.en-retard::before { background: #dc3545; }

  .evaluation-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }

  .countdown-badge {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 0.9rem;
  }

  .status-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 1.5rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .progress-bar-custom {
    height: 8px;
    border-radius: 4px;
    background: #e9ecef;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
  }

  .stats-overview {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .quick-access {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="h3 mb-1"><i class="fas fa-clipboard-check text-primary me-2"></i>Mes Évaluations</h1>
      <p class="text-muted mb-0">Consultez vos évaluations et soumettez vos compositions</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'evaluations:mes_notes' %}" class="btn btn-outline-primary">
        <i class="fas fa-chart-line me-2"></i>Mes Notes
      </a>
      <button class="btn btn-outline-secondary" onclick="actualiserPage()">
        <i class="fas fa-sync-alt me-2"></i>Actualiser
      </button>
    </div>
  </div>
</div>

<!-- Statistiques personnelles -->
<div class="stats-overview">
  <div class="row text-center">
    <div class="col-md-3 col-6">
      <div class="h3 mb-1">{{ stats_personnelles.total_evaluations }}</div>
      <div class="small">Total évaluations</div>
    </div>
    <div class="col-md-3 col-6">
      <div class="h3 mb-1">{{ stats_personnelles.en_cours }}</div>
      <div class="small">En cours</div>
    </div>
    <div class="col-md-3 col-6">
      <div class="h3 mb-1">{{ stats_personnelles.compositions_soumises }}</div>
      <div class="small">Soumises</div>
    </div>
    <div class="col-md-3 col-6">
      <div class="h3 mb-1">{{ stats_personnelles.compositions_corrigees }}</div>
      <div class="small">Corrigées</div>
    </div>
  </div>
</div>

<!-- Accès rapide -->
<div class="quick-access">
  <div class="row">
    <div class="col-md-3">
      <label class="form-label">Rechercher</label>
      {{ form.titre }}
    </div>
    <div class="col-md-3">
      <label class="form-label">Type</label>
      {{ form.type_evaluation }}
    </div>
    <div class="col-md-3">
      <label class="form-label">Matière</label>
      {{ form.matiere }}
    </div>
    <div class="col-md-3">
      <label class="form-label">&nbsp;</label>
      <div class="d-grid">
        <button type="button" onclick="filtrerEvaluations()" class="btn btn-primary">
          <i class="fas fa-filter"></i> Filtrer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Liste des évaluations -->
<div class="row">
  {% for info in evaluations_avec_info %}
  {% with evaluation=info.evaluation composition=info.composition disponibilite=info.disponibilite temps_restant=info.temps_restant note=info.note %}
  <div class="col-12">
    <div class="evaluation-card {% if evaluation.statut == 'EN_COURS' and disponibilite.peut_composer %}active{% elif evaluation.statut == 'TERMINEE' %}terminee{% elif evaluation.statut == 'PROGRAMMEE' %}programmee{% elif composition and composition.est_en_retard %}en-retard{% endif %}">
      <div class="row align-items-center">
        <!-- Informations de l'évaluation -->
        <div class="col-lg-6">
          <div class="d-flex align-items-start">
            <div class="flex-grow-1">
              <h5 class="mb-2">
                <a href="{% url 'evaluations:detail_apprenant' evaluation.pk %}"
                   class="text-decoration-none text-dark">
                  {{ evaluation.titre }}
                </a>
              </h5>

              <p class="text-muted mb-2">
                <i class="fas fa-book me-1"></i>
                {{ evaluation.matiere_module.matiere.nom }} - {{ evaluation.matiere_module.module.nom }}
              </p>

              <p class="text-muted small mb-2">
                <i class="fas fa-user me-1"></i>
                Prof. {{ evaluation.enseignant.get_full_name }}
              </p>

              <div class="d-flex align-items-center gap-3">
                <span class="status-badge bg-{% if evaluation.statut == 'EN_COURS' %}success{% elif evaluation.statut == 'PROGRAMMEE' %}info{% elif evaluation.statut == 'TERMINEE' %}secondary{% else %}warning{% endif %} text-white">
                  {{ evaluation.get_statut_display }}
                </span>

                <small class="text-muted">
                  <i class="fas fa-calendar me-1"></i>
                  {{ evaluation.date_debut|date:"d/m/Y H:i" }}
                </small>

                <small class="text-muted">
                  <i class="fas fa-star me-1"></i>
                  Coeff: {{ evaluation.coefficient }}
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Statut de la composition -->
        <div class="col-lg-3">
          <div class="text-center">
            {% if composition %}
              {% if composition.statut == 'EN_COURS' %}
                <div class="text-warning">
                  <i class="fas fa-clock fa-2x mb-2"></i>
                  <div class="fw-bold">En cours</div>
                  <small class="text-muted">Composition ouverte</small>
                </div>
              {% elif composition.statut == 'SOUMISE' %}
                <div class="text-success">
                  <i class="fas fa-check-circle fa-2x mb-2"></i>
                  <div class="fw-bold">Soumise</div>
                  <small class="text-muted">{{ composition.date_soumission|date:"d/m H:i" }}</small>
                </div>
              {% elif composition.statut == 'EN_RETARD' %}
                <div class="text-danger">
                  <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                  <div class="fw-bold">En retard</div>
                  <small class="text-muted">{{ composition.date_soumission|date:"d/m H:i" }}</small>
                </div>
              {% elif composition.statut == 'CORRIGEE' %}
                <div class="text-info">
                  <i class="fas fa-medal fa-2x mb-2"></i>
                  <div class="fw-bold">Corrigée</div>
                  {% if note %}
                    <div class="h5 text-primary mb-0">{{ note.valeur }}/{{ note.note_sur }}</div>
                  {% endif %}
                </div>
              {% endif %}
            {% else %}
              <div class="text-muted">
                <i class="fas fa-file-alt fa-2x mb-2"></i>
                <div class="fw-bold">Non démarrée</div>
                <small>Cliquez pour commencer</small>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Actions et temps restant -->
        <div class="col-lg-3 text-end">
          {% if evaluation.statut == 'EN_COURS' and disponibilite.peut_composer %}
            {% if temps_restant > 0 %}
              <div class="countdown-badge mb-2" data-end-time="{{ evaluation.date_fin.isoformat }}">
                --:--:--
              </div>
            {% endif %}

            <div class="d-grid gap-2">
              <a href="{% url 'evaluations:detail_apprenant' evaluation.pk %}"
                 class="btn btn-primary">
                {% if composition and composition.statut == 'EN_COURS' %}
                  <i class="fas fa-edit me-2"></i>Continuer
                {% else %}
                  <i class="fas fa-play me-2"></i>Commencer
                {% endif %}
              </a>
            </div>

          {% elif evaluation.statut == 'PROGRAMMEE' %}
            <div class="text-center">
              <div class="text-muted">
                <i class="fas fa-clock me-1"></i>
                Commence le
              </div>
              <div class="fw-bold">{{ evaluation.date_debut|date:"d/m/Y à H:i" }}</div>
            </div>

          {% elif evaluation.statut == 'TERMINEE' %}
            <div class="d-grid gap-2">
              <a href="{% url 'evaluations:detail_apprenant' evaluation.pk %}"
                 class="btn btn-outline-secondary">
                <i class="fas fa-eye me-2"></i>Voir résultats
              </a>

              {% if evaluation.correction_visible %}
                <a href="{% url 'evaluations:voir_fichier' 'correction' evaluation.pk %}"
                   class="btn btn-outline-success"
                   data-bs-toggle="modal"
                   data-bs-target="#fileViewerModal">
                  <i class="fas fa-file-check me-2"></i>Correction
                </a>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Barre de progression si composition en cours -->
      {% if composition and composition.statut == 'EN_COURS' and temps_restant > 0 %}
      <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <small class="text-muted">Progression</small>
          <small class="text-muted">{{ composition.fichiers_composition.count }} fichier{{ composition.fichiers_composition.count|pluralize }} uploadé{{ composition.fichiers_composition.count|pluralize }}</small>
        </div>
        <div class="progress-bar-custom">
          <div class="progress-bar-fill bg-primary"
               style="width: {% if composition.fichiers_composition.count > 0 %}50%{% else %}10%{% endif %}"></div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endwith %}
  {% empty %}
  <div class="col-12">
    <div class="text-center py-5">
      <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">Aucune évaluation disponible</h4>
      <p class="text-muted">Vos évaluations apparaîtront ici dès qu'elles seront programmées par vos enseignants.</p>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Modal pour visualiser les fichiers -->
<div class="modal fade" id="fileViewerModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Visualisation du fichier</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <div id="fileViewerContent" style="height: 70vh;">
          <div class="d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <a href="#" class="btn btn-primary" id="downloadFileBtn">
          <i class="fas fa-download"></i> Télécharger
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Mise à jour des compteurs de temps
function updateCountdowns() {
    document.querySelectorAll('[data-end-time]').forEach(element => {
        const endTime = new Date(element.dataset.endTime);
        const now = new Date();
        const diff = endTime - now;

        if (diff > 0) {
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            element.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Changer la couleur selon le temps restant
            if (diff < 300000) { // Moins de 5 minutes
                element.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
            } else if (diff < 900000) { // Moins de 15 minutes
                element.style.background = 'linear-gradient(45deg, #ffc107, #e0a800)';
            }
        } else {
            element.textContent = 'Terminé';
            element.style.background = '#6c757d';
        }
    });
}

function filtrerEvaluations() {
    const titre = document.querySelector('[name="titre"]').value;
    const type = document.querySelector('[name="type_evaluation"]').value;
    const matiere = document.querySelector('[name="matiere"]').value;

    const params = new URLSearchParams();
    if (titre) params.append('titre', titre);
    if (type) params.append('type_evaluation', type);
    if (matiere) params.append('matiere', matiere);

    window.location.href = '?' + params.toString();
}

function actualiserPage() {
    location.reload();
}

document.addEventListener('DOMContentLoaded', function() {
    updateCountdowns();
    setInterval(updateCountdowns, 1000);

    // Actualisation automatique toutes les 30 secondes
    setInterval(function() {
        // Uniquement si une évaluation est en cours
        if (document.querySelector('.evaluation-card.active')) {
            location.reload();
        }
    }, 30000);
});

// Gestion du modal de visualisation de fichiers
document.addEventListener('click', function(e) {
    if (e.target.matches('[data-bs-target="#fileViewerModal"]') || e.target.closest('[data-bs-target="#fileViewerModal"]')) {
        const link = e.target.matches('a') ? e.target : e.target.closest('a');
        const fileUrl = link.href;
        const fileName = link.textContent.trim();

        document.getElementById('fileViewerContent').innerHTML = `
            <iframe src="${fileUrl}" style="width: 100%; height: 100%; border: none;"></iframe>
        `;

        document.getElementById('downloadFileBtn').href = fileUrl;
        document.querySelector('#fileViewerModal .modal-title').textContent = `Visualisation - ${fileName}`;

        e.preventDefault();
    }
});
</script>
{% endblock %}