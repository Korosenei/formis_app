<!-- templates/dashboard/modals/change_password.html -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-lock"></i> Changer mon mot de passe
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="changePasswordForm" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Alerte -->
                    <div id="passwordAlert" class="alert" style="display: none;"></div>

                    <!-- Instructions -->
                    <div class="password-instructions">
                        <p><i class="fas fa-info-circle"></i> Votre nouveau mot de passe doit contenir :</p>
                        <ul>
                            <li id="rule-length">
                                <i class="fas fa-circle rule-icon"></i>
                                Au moins 8 caractères
                            </li>
                            <li id="rule-uppercase">
                                <i class="fas fa-circle rule-icon"></i>
                                Au moins une lettre majuscule
                            </li>
                            <li id="rule-lowercase">
                                <i class="fas fa-circle rule-icon"></i>
                                Au moins une lettre minuscule
                            </li>
                            <li id="rule-number">
                                <i class="fas fa-circle rule-icon"></i>
                                Au moins un chiffre
                            </li>
                        </ul>
                    </div>

                    <!-- Ancien mot de passe -->
                    <div class="form-group">
                        <label for="old_password">
                            Mot de passe actuel <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <input type="password" class="form-control" id="old_password"
                                   name="old_password" required autocomplete="current-password"
                                   placeholder="Entrez votre mot de passe actuel">
                            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('old_password')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Nouveau mot de passe -->
                    <div class="form-group">
                        <label for="new_password1">
                            Nouveau mot de passe <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <input type="password" class="form-control" id="new_password1"
                                   name="new_password1" required autocomplete="new-password"
                                   placeholder="Entrez votre nouveau mot de passe">
                            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('new_password1')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <!-- Barre de force du mot de passe -->
                        <div class="password-strength-bar">
                            <div class="strength-bar-fill" id="strengthBar"></div>
                        </div>
                        <small class="strength-text" id="strengthText"></small>
                    </div>

                    <!-- Confirmation -->
                    <div class="form-group">
                        <label for="new_password2">
                            Confirmer le nouveau mot de passe <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <input type="password" class="form-control" id="new_password2"
                                   name="new_password2" required autocomplete="new-password"
                                   placeholder="Confirmez votre nouveau mot de passe">
                            <button type="button" class="toggle-password" onclick="togglePasswordVisibility('new_password2')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="match-indicator" id="matchIndicator"></small>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" data-dismiss="modal">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                        <i class="fas fa-lock"></i> Changer le mot de passe
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Instructions de sécurité */
.password-instructions {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;
}

.password-instructions p {
    margin: 0 0 10px 0;
    font-weight: 500;
    color: var(--text-dark);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.password-instructions ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.password-instructions li {
    padding: 5px 0;
    font-size: 12px;
    color: #6c757d;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.rule-icon {
    font-size: 6px;
    color: #6c757d;
    transition: all 0.3s;
}

.password-instructions li.valid {
    color: #28a745;
    font-weight: 500;
}

.password-instructions li.valid .rule-icon {
    color: #28a745;
    font-size: 10px;
}

/* Champs avec icône */
.input-with-icon {
    position: relative;
}

.input-with-icon .form-control {
    padding-right: 45px;
}

.toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 5px 10px;
    transition: all 0.3s;
    z-index: 10;
}

.toggle-password:hover {
    color: var(--primary-color);
}

.toggle-password:focus {
    outline: none;
}

/* Barre de force */
.password-strength-bar {
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
}

.strength-bar-fill {
    height: 100%;
    width: 0;
    transition: all 0.3s;
    border-radius: 2px;
}

.strength-bar-fill.weak {
    width: 33%;
    background: #dc3545;
}

.strength-bar-fill.medium {
    width: 66%;
    background: #ffc107;
}

.strength-bar-fill.strong {
    width: 100%;
    background: #28a745;
}

/* Texte de force */
.strength-text {
    display: block;
    margin-top: 5px;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.3s;
}

.strength-text.weak {
    color: #dc3545;
}

.strength-text.medium {
    color: #ffc107;
}

.strength-text.strong {
    color: #28a745;
}

/* Indicateur de correspondance */
.match-indicator {
    display: block;
    margin-top: 5px;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.3s;
}

.match-indicator.match {
    color: #28a745;
}

.match-indicator.nomatch {
    color: #dc3545;
}

/* Champs requis */
.required {
    color: #dc3545;
    margin-left: 2px;
}

/* Alerte */
#passwordAlert {
    margin-bottom: 20px;
}

.alert {
    padding: 12px 15px;
    border-radius: 6px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert-success {
    background: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
}

.alert-danger {
    background: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
}
</style>

<script>
$(document).ready(function() {
    // Validation en temps réel du mot de passe
    $('#new_password1').on('input', function() {
        const password = $(this).val();
        validatePasswordStrength(password);
    });

    // Vérification de la correspondance
    $('#new_password2').on('input', function() {
        checkPasswordsMatch();
    });

    // Vérifier aussi quand on modifie le premier champ
    $('#new_password1').on('input', function() {
        if ($('#new_password2').val().length > 0) {
            checkPasswordsMatch();
        }
    });

    // Soumission du formulaire
    $('#changePasswordForm').on('submit', function(e) {
        e.preventDefault();

        const oldPassword = $('#old_password').val().trim();
        const newPassword1 = $('#new_password1').val();
        const newPassword2 = $('#new_password2').val();

        // Validations côté client
        if (!oldPassword) {
            showPasswordAlert('danger', 'Veuillez entrer votre mot de passe actuel');
            return;
        }

        if (newPassword1 !== newPassword2) {
            showPasswordAlert('danger', 'Les nouveaux mots de passe ne correspondent pas');
            return;
        }

        if (newPassword1.length < 8) {
            showPasswordAlert('danger', 'Le nouveau mot de passe doit contenir au moins 8 caractères');
            return;
        }

        if (oldPassword === newPassword1) {
            showPasswordAlert('danger', 'Le nouveau mot de passe doit être différent de l\'ancien');
            return;
        }

        // Désactiver le bouton pendant le traitement
        const $btn = $('#changePasswordBtn');
        const originalText = $btn.html();
        $btn.html('<i class="fas fa-spinner fa-spin"></i> Modification en cours...').prop('disabled', true);

        // Envoi AJAX
        $.ajax({
            url: '{% url "accounts:change_password" %}',
            type: 'POST',
            data: $(this).serialize(),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                showPasswordAlert('success', '✓ ' + (response.message || 'Mot de passe modifié avec succès'));

                // Réinitialiser le formulaire après 1.5 secondes
                setTimeout(function() {
                    $('#changePasswordModal').modal('hide');
                    $('#changePasswordForm')[0].reset();
                    resetPasswordValidation();

                    // Recharger la page ou afficher un message global
                    location.reload();
                }, 1500);
            },
            error: function(xhr) {
                let errorMsg = 'Une erreur est survenue lors du changement de mot de passe';

                if (xhr.responseJSON && xhr.responseJSON.errors) {
                    const errors = xhr.responseJSON.errors;

                    if (errors.old_password) {
                        errorMsg = '✗ ' + (Array.isArray(errors.old_password)
                            ? errors.old_password[0]
                            : 'Mot de passe actuel incorrect');
                    } else if (errors.new_password2) {
                        errorMsg = '✗ ' + (Array.isArray(errors.new_password2)
                            ? errors.new_password2.join(', ')
                            : errors.new_password2);
                    } else if (errors.new_password1) {
                        errorMsg = '✗ ' + (Array.isArray(errors.new_password1)
                            ? errors.new_password1.join(', ')
                            : errors.new_password1);
                    } else if (errors.__all__) {
                        errorMsg = '✗ ' + errors.__all__.join(', ');
                    }
                } else if (xhr.status === 403) {
                    errorMsg = '✗ Session expirée. Veuillez vous reconnecter';
                }

                showPasswordAlert('danger', errorMsg);
                $btn.html(originalText).prop('disabled', false);
            }
        });
    });

    // Réinitialiser à la fermeture du modal
    $('#changePasswordModal').on('hidden.bs.modal', function() {
        $('#changePasswordForm')[0].reset();
        $('#passwordAlert').hide();
        resetPasswordValidation();
    });
});

// Valider la force du mot de passe
function validatePasswordStrength(password) {
    const rules = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password)
    };

    // Mettre à jour les indicateurs visuels
    $('#rule-length').toggleClass('valid', rules.length);
    $('#rule-uppercase').toggleClass('valid', rules.uppercase);
    $('#rule-lowercase').toggleClass('valid', rules.lowercase);
    $('#rule-number').toggleClass('valid', rules.number);

    // Calculer la force
    const validRules = Object.values(rules).filter(Boolean).length;
    const $strengthBar = $('#strengthBar');
    const $strengthText = $('#strengthText');

    // Réinitialiser les classes
    $strengthBar.removeClass('weak medium strong');
    $strengthText.removeClass('weak medium strong');

    if (password.length === 0) {
        $strengthBar.css('width', '0');
        $strengthText.text('');
    } else if (validRules <= 2) {
        $strengthBar.addClass('weak');
        $strengthText.addClass('weak').text('✗ Faible');
    } else if (validRules === 3) {
        $strengthBar.addClass('medium');
        $strengthText.addClass('medium').text('⚠ Moyen');
    } else {
        $strengthBar.addClass('strong');
        $strengthText.addClass('strong').text('✓ Fort');
    }
}

// Vérifier la correspondance des mots de passe
function checkPasswordsMatch() {
    const password1 = $('#new_password1').val();
    const password2 = $('#new_password2').val();
    const $indicator = $('#matchIndicator');

    if (password2.length === 0) {
        $indicator.text('').removeClass('match nomatch');
        return;
    }

    if (password1 === password2) {
        $indicator.text('✓ Les mots de passe correspondent')
                  .removeClass('nomatch')
                  .addClass('match');
    } else {
        $indicator.text('✗ Les mots de passe ne correspondent pas')
                  .removeClass('match')
                  .addClass('nomatch');
    }
}

// Afficher/masquer le mot de passe
function togglePasswordVisibility(fieldId) {
    const $field = $('#' + fieldId);
    const $icon = $field.siblings('.toggle-password').find('i');

    if ($field.attr('type') === 'password') {
        $field.attr('type', 'text');
        $icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        $field.attr('type', 'password');
        $icon.removeClass('fa-eye-slash').addClass('fa-eye');
    }
}

// Réinitialiser la validation
function resetPasswordValidation() {
    $('.password-instructions li').removeClass('valid');
    $('#strengthBar').removeClass('weak medium strong').css('width', '0');
    $('#strengthText').text('').removeClass('weak medium strong');
    $('#matchIndicator').text('').removeClass('match nomatch');
}

// Afficher une alerte
function showPasswordAlert(type, message) {
    const $alert = $('#passwordAlert');
    const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';

    $alert.removeClass('alert-success alert-danger')
          .addClass(`alert-${type}`)
          .html(icon + ' ' + message)
          .fadeIn();

    // Masquer automatiquement après 5 secondes
    setTimeout(function() {
        $alert.fadeOut();
    }, 5000);
}
</script>