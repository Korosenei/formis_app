{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block page_title %}Tableau de bord - Apprenant{% endblock %}
{% block breadcrumb %}Dashboard > Apprenant{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard/student.css">
{% endblock %}

{% block content %}
<div class="student-dashboard">
    <!-- Statistiques générales -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <div class="stat-icon">
                <i class="fas fa-book"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_cours }}</h3>
                <p>Cours suivis</p>
                <span class="stat-info">
                    {{ classe_assignee.nom|default:"N/A" }}
                </span>
            </div>
        </div>

        <div class="stat-card success">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3>{{ moyenne_generale }}/20</h3>
                <p>Moyenne générale</p>
                <span class="stat-change {% if moyenne_generale >= 12 %}positive{% else %}negative{% endif %}">
                    {% if moyenne_generale >= 12 %}
                        <i class="fas fa-arrow-up"></i> Bon niveau
                    {% else %}
                        <i class="fas fa-arrow-down"></i> À améliorer
                    {% endif %}
                </span>
            </div>
        </div>

        <div class="stat-card warning">
            <div class="stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
                <h3>{{ taux_presence }}%</h3>
                <p>Taux de présence</p>
                <span class="stat-info">
                    {% if taux_presence >= 75 %}Bon{% else %}À améliorer{% endif %}
                </span>
            </div>
        </div>

        <div class="stat-card {% if statut_financier.est_en_retard %}danger{% else %}info{% endif %}">
            <div class="stat-icon">
                <i class="fas fa-credit-card"></i>
            </div>
            <div class="stat-content">
                <h3>{{ statut_financier.pourcentage|default:0 }}%</h3>
                <p>Scolarité payée</p>
                <span class="stat-info">
                    {{ statut_financier.statut_display|default:"N/A" }}
                </span>
            </div>
        </div>
    </div>

    <!-- Prochain cours -->
    {% if prochain_cours %}
    <div class="next-course-card">
        <div class="course-header">
            <h4>
                <i class="fas fa-clock"></i>
                Prochain cours
            </h4>
            <span class="badge badge-today">
                {% if prochain_cours.date_prevue.date == today %}
                    Aujourd'hui
                {% else %}
                    {{ prochain_cours.date_prevue|date:"d/m/Y" }}
                {% endif %}
            </span>
        </div>
        <div class="course-body">
            <h5>{{ prochain_cours.cours.matiere.nom }}</h5>
            <div class="course-details">
                <span>
                    <i class="fas fa-calendar"></i>
                    {{ prochain_cours.date_prevue|time:"H:i" }}
                </span>
                <span>
                    <i class="fas fa-door-open"></i>
                    {{ prochain_cours.salle.nom }}
                </span>
                <span>
                    <i class="fas fa-user"></i>
                    {{ prochain_cours.cours.enseignant.get_full_name }}
                </span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Sections principales -->
    <div class="content-sections">
        <!-- Mes cours -->
        <div class="section-card">
            <div class="section-header">
                <h4>
                    <i class="fas fa-book-open"></i>
                    Mes cours
                </h4>
                <a href="{% url 'dashboard:student_courses' %}" class="view-all">Voir tout</a>
            </div>
            <div class="section-body">
                {% if mes_cours %}
                    {% for cours in mes_cours|slice:":5" %}
                    <div class="item-row">
                        <div class="item-icon primary">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="item-content">
                            <h5>{{ cours.matiere.nom }}</h5>
                            <p class="text-muted">{{ cours.enseignant.get_full_name }}</p>
                        </div>
                        <div class="item-status">
                            <div class="progress-mini">
                                <div class="progress-bar" style="width: 65%"></div>
                            </div>
                            <small>65%</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-book-open"></i>
                    <p>Aucun cours assigné</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Évaluations à venir -->
        <div class="section-card">
            <div class="section-header">
                <h4>
                    <i class="fas fa-edit"></i>
                    Évaluations à venir
                </h4>
                <a href="{% url 'dashboard:student_evaluations' %}" class="view-all">Voir tout</a>
            </div>
            <div class="section-body">
                {% if evaluations_a_venir %}
                    {% for eval in evaluations_a_venir|slice:":5" %}
                    <div class="item-row">
                        <div class="item-icon warning">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="item-content">
                            <h5>{{ eval.titre }}</h5>
                            <p class="text-muted">{{ eval.cours.matiere.nom }}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar"></i>
                                {{ eval.date_evaluation|date:"d/m/Y H:i" }}
                            </small>
                        </div>
                        <div class="item-status">
                            <span class="badge badge-warning">À venir</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-edit"></i>
                    <p>Aucune évaluation programmée</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Dernières notes -->
        <div class="section-card">
            <div class="section-header">
                <h4>
                    <i class="fas fa-chart-bar"></i>
                    Dernières notes
                </h4>
                <a href="{% url 'dashboard:student_resultats' %}" class="view-all">Voir tout</a>
            </div>
            <div class="section-body">
                {% if dernieres_notes %}
                    {% for note in dernieres_notes|slice:":5" %}
                    <div class="item-row">
                        <div class="item-content">
                            <h5>{{ note.evaluation.cours.matiere.nom }}</h5>
                            <p class="text-muted">{{ note.evaluation.titre }}</p>
                        </div>
                        <div class="item-status">
                            <span class="badge {% if note.valeur >= 10 %}badge-success{% else %}badge-danger{% endif %}">
                                {{ note.valeur }}/20
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-chart-bar"></i>
                    <p>Aucune note publiée</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Situation financière -->
        <div class="section-card">
            <div class="section-header">
                <h4>
                    <i class="fas fa-credit-card"></i>
                    Situation financière
                </h4>
                <a href="{% url 'dashboard:student_paiements' %}" class="view-all">Détails</a>
            </div>
            <div class="section-body">
                {% if inscription_paiement %}
                <div class="payment-summary">
                    <div class="payment-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: {{ statut_financier.pourcentage }}%"></div>
                        </div>
                        <div class="payment-amounts">
                            <span>Payé: {{ statut_financier.total_paye|floatformat:0 }} XOF</span>
                            <span>Reste: {{ statut_financier.solde|floatformat:0 }} XOF</span>
                        </div>
                    </div>
                    <div class="payment-total">
                        <strong>Total: {{ inscription_paiement.montant_total_du|floatformat:0 }} XOF</strong>
                    </div>
                </div>

                {% if statut_financier.peut_payer_tranche %}
                <div class="text-center mt-3">
                    <form action="{% url 'payments:payer_prochaine_tranche' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-credit-card"></i>
                            Payer prochaine tranche
                        </button>
                    </form>
                </div>
                {% endif %}
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-credit-card"></i>
                    <p>Aucune information disponible</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Notifications récentes -->
    {% if notifications %}
    <div class="notifications-card">
        <div class="section-header">
            <h4>
                <i class="fas fa-bell"></i>
                Notifications récentes
            </h4>
        </div>
        <div class="notifications-list">
            {% for notif in notifications|slice:":5" %}
            <div class="notification-item">
                <div class="notif-icon" style="background: {{ notif.color }}">
                    <i class="{{ notif.icon }}"></i>
                </div>
                <div class="notif-content">
                    <h6>{{ notif.title }}</h6>
                    <p>{{ notif.message }}</p>
                    <small>{{ notif.timestamp|timesince }} ago</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal d'inscription -->
{% include 'components/inscription_modal.html' %}

<style>
.student-dashboard {
    padding: 15px;
    max-width: 100%;
    overflow-x: hidden;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    padding: 14px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 12px;
    border-left: 3px solid;
    min-height: 75px;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.stat-card.primary { border-color: #4e73df; }
.stat-card.success { border-color: #1cc88a; }
.stat-card.warning { border-color: #f6c23e; }
.stat-card.danger { border-color: #e74a3b; }
.stat-card.info { border-color: #36b9cc; }

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: white;
    flex-shrink: 0;
}

.stat-card.primary .stat-icon { background: #4e73df; }
.stat-card.success .stat-icon { background: #1cc88a; }
.stat-card.warning .stat-icon { background: #f6c23e; }
.stat-card.danger .stat-icon { background: #e74a3b; }
.stat-card.info .stat-icon { background: #36b9cc; }

.stat-content {
    flex: 1;
    min-width: 0;
}

.stat-content h3 {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 3px 0;
    color: #2d3748;
}

.stat-content p {
    color: #718096;
    margin: 0 0 5px 0;
    font-size: 12px;
    font-weight: 500;
}

.stat-info, .stat-change {
    font-size: 11px;
    font-weight: 500;
}

.stat-info {
    color: #6c757d;
}

.stat-change {
    padding: 2px 6px;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    gap: 3px;
}

.stat-change.positive {
    background: #d1e7dd;
    color: #0a3622;
}

.stat-change.negative {
    background: #f8d7da;
    color: #58151c;
}

.next-course-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    padding: 18px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.course-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.course-header h4 {
    color: white;
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.badge-today {
    background: rgba(255, 255, 255, 0.25);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.course-body h5 {
    color: white;
    margin: 0 0 10px 0;
    font-size: 18px;
    font-weight: 600;
}

.course-details {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.course-details span {
    color: rgba(255, 255, 255, 0.9);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.content-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.section-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
    border: 1px solid #e2e8f0;
}

.section-header {
    padding: 15px 18px;
    border-bottom: 1px solid #e3e6f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.section-header h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: #2d3748;
    display: flex;
    align-items: center;
    gap: 8px;
}

.view-all {
    color: #4e73df;
    text-decoration: none;
    font-size: 12px;
    font-weight: 500;
}

.view-all:hover {
    text-decoration: underline;
}

.section-body {
    max-height: 320px;
    overflow-y: auto;
    padding: 15px 18px;
}

.item-row {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f8f9fc;
    gap: 12px;
}

.item-row:hover {
    background-color: #f8f9fc;
    margin: 0 -10px;
    padding-left: 10px;
    padding-right: 10px;
    border-radius: 6px;
}

.item-row:last-child {
    border-bottom: none;
}

.item-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: white;
    flex-shrink: 0;
}

.item-icon.primary { background: #4e73df; }
.item-icon.warning { background: #f6c23e; }

.item-content {
    flex: 1;
    min-width: 0;
}

.item-content h5 {
    margin: 0 0 3px 0;
    font-size: 13px;
    font-weight: 600;
    color: #2d3748;
}

.item-content p {
    margin: 0 0 3px 0;
    font-size: 12px;
    color: #718096;
}

.item-content small {
    font-size: 11px;
    color: #a0aec0;
}

.item-status {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
}

.progress-mini {
    width: 60px;
    height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
}

.progress-mini .progress-bar {
    height: 100%;
    background: linear-gradient(135deg, #1cc88a 0%, #17a2b8 100%);
}

.badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-warning { background: #fff3cd; color: #856404; }
.badge-success { background: #d1e7dd; color: #0a3622; }
.badge-danger { background: #f8d7da; color: #58151c; }

.empty-state {
    padding: 30px;
    text-align: center;
    color: #a0aec0;
    font-size: 13px;
}

.empty-state i {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
}

.payment-summary {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
}

.payment-progress {
    margin-bottom: 12px;
}

.progress-bar-container {
    width: 100%;
    height: 10px;
    background: #e2e8f0;
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 8px;
}

.progress-bar-container .progress-bar {
    height: 100%;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    transition: width 0.3s ease;
}

.payment-amounts {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #6c757d;
}

.payment-total {
    text-align: center;
    padding-top: 12px;
    border-top: 1px solid #dee2e6;
    font-size: 14px;
    color: #2d3748;
}

.btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    font-size: 13px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary {
    background: #4e73df;
    color: white;
}

.btn-primary:hover {
    background: #3a5dc7;
    transform: translateY(-1px);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.notifications-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
    border: 1px solid #e2e8f0;
}

.notifications-list {
    padding: 15px 18px;
}

.notification-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid #f8f9fc;
}

.notification-item:last-child {
    border-bottom: none;
}

.notif-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    flex-shrink: 0;
}

.notif-content {
    flex: 1;
}

.notif-content h6 {
    margin: 0 0 3px 0;
    font-size: 13px;
    font-weight: 600;
    color: #2d3748;
}

.notif-content p {
    margin: 0 0 3px 0;
    font-size: 12px;
    color: #718096;
}

.notif-content small {
    font-size: 11px;
    color: #a0aec0;
}

/* Responsive */
@media (max-width: 992px) {
    .content-sections {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .student-dashboard {
        padding: 10px;
    }

    .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }

    .course-details {
        flex-direction: column;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier l'accès
    const peutAcceder = {{ peut_acceder|yesno:"true,false" }};

    if (!peutAcceder) {
        const statutModal = "{{ statut_modal|default:'inscription_requise' }}";
        const message = "{{ message_modal|default:'Inscription requise' }}";

        updateModalContent(statutModal, {
            message: message,
            candidatures_approuvees: {{ candidatures_approuvees|default:0 }},
            paiements_en_cours: {{ paiements_en_cours|default:0 }}
        });

        const modal = new bootstrap.Modal(document.getElementById('inscriptionModal'));
        modal.show();
    }

    // Actualiser si paiements en cours
    {% if paiements_en_cours > 0 %}
    setTimeout(() => window.location.reload(), 30000);
    {% endif %}
});

function updateModalContent(statut, data) {
    // Fonction de mise à jour du modal (à implémenter selon vos besoins)
    console.log('Modal update:', statut, data);
}
</script>
{% endblock %}