{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block page_title %}Tableau de Bord - Apprenant{% endblock %}
{% block breadcrumb %}Tableau de bord{% endblock %}

{% block extra_css %}
<style>
    .dashboard-student {
        padding: 20px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient);
    }

    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }

    .stat-card.courses::before { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card.grades::before { background: linear-gradient(135deg, #1cc88a 0%, #17a2b8 100%); }
    .stat-card.attendance::before { background: linear-gradient(135deg, #f6c23e 0%, #fd7e14 100%); }
    .stat-card.payments::before { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }

    .stat-icon {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
        position: relative;
    }

    .stat-icon.courses { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.grades { background: linear-gradient(135deg, #1cc88a 0%, #17a2b8 100%); }
    .stat-icon.attendance { background: linear-gradient(135deg, #f6c23e 0%, #fd7e14 100%); }
    .stat-icon.payments { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }

    .stat-info h3 {
        margin: 0;
        font-size: 32px;
        font-weight: 700;
        color: #2c3e50;
    }

    .stat-info p {
        margin: 5px 0 0;
        color: #6c757d;
        font-weight: 500;
    }

    /* Prochain cours highlight */
    .next-course-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .next-course {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
    }

    .course-info h4 {
        color: white;
        margin-bottom: 15px;
        font-size: 24px;
        font-weight: 600;
    }

    .course-info p {
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .course-actions .badge {
        padding: 12px 20px;
        font-size: 14px;
        border-radius: 25px;
        font-weight: 600;
    }

    .badge-today {
        background: rgba(255, 193, 7, 0.9);
        color: #212529;
    }

    .badge-upcoming {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
    }

    .content-card {
        background: white;
        border-radius: 18px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .content-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.12);
    }

    .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 25px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .card-title i {
        color: #667eea;
        font-size: 20px;
    }

    .card-body {
        padding: 25px;
    }

    .course-item, .evaluation-item, .grade-item {
        display: flex;
        align-items: center;
        padding: 18px 0;
        border-bottom: 1px solid #f1f3f4;
        transition: all 0.3s ease;
    }

    .course-item:hover, .evaluation-item:hover, .grade-item:hover {
        background-color: #f8f9ff;
        border-radius: 12px;
        margin: 0 -15px;
        padding-left: 15px;
        padding-right: 15px;
    }

    .course-item:last-child,
    .evaluation-item:last-child,
    .grade-item:last-child {
        border-bottom: none;
    }

    .course-icon, .eval-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: white;
        font-size: 20px;
    }

    .eval-icon {
        background: linear-gradient(135deg, #f6c23e 0%, #fd7e14 100%);
    }

    .course-details, .eval-details {
        flex-grow: 1;
    }

    .course-details h5, .eval-details h6 {
        margin: 0 0 8px 0;
        color: #2c3e50;
        font-weight: 600;
        font-size: 16px;
    }

    .course-details .text-muted, .eval-details .text-muted {
        color: #6c757d !important;
        font-size: 14px;
        margin-bottom: 4px;
    }

    .course-progress {
        display: flex;
        flex-direction: column;
        align-items: end;
        gap: 8px;
    }

    .progress {
        width: 100px;
        height: 8px;
        background-color: #f1f3f4;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(135deg, #1cc88a 0%, #17a2b8 100%);
        border-radius: 10px;
        transition: width 0.6s ease;
    }

    .grade-item {
        justify-content: space-between;
    }

    .grade-subject strong {
        color: #2c3e50;
        font-weight: 600;
    }

    .grade-subject small {
        color: #6c757d;
        display: block;
        margin-top: 4px;
    }

    .grade-value .badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }

    .badge-success { background: #28a745; }
    .badge-danger { background: #dc3545; }
    .badge-warning { background: #ffc107; color: #212529; }
    .badge-info { background: #17a2b8; }

    /* Section paiements */
    .payment-status {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
    }

    .payment-progress {
        margin-bottom: 15px;
    }

    .payment-progress .progress {
        width: 100%;
        height: 12px;
        background: #dee2e6;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .payment-progress .progress-bar {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .payment-info {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: #6c757d;
        margin-top: 8px;
    }

    .payment-total {
        text-align: center;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
        font-weight: 600;
        color: #2c3e50;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .btn-outline {
        border: 2px solid #667eea;
        color: #667eea;
        background: transparent;
    }

    .btn-outline:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #dee2e6;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .next-course {
            flex-direction: column;
            text-align: center;
        }

        .stat-card {
            padding: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            font-size: 24px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-student">
    <!-- Vérification du statut d'inscription -->
    {% if not peut_acceder %}
        <!-- Le modal sera géré par JavaScript -->
    {% endif %}

    <!-- Statistiques rapides -->
    <div class="stats-grid">
        <div class="stat-card courses">
            <div class="stat-icon courses">
                <i class="fas fa-book"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_cours }}</h3>
                <p>Cours suivis</p>
            </div>
        </div>

        <div class="stat-card grades">
            <div class="stat-icon grades">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-info">
                <h3>{{ moyenne_generale }}/20</h3>
                <p>Moyenne générale</p>
            </div>
        </div>

        <div class="stat-card attendance">
            <div class="stat-icon attendance">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-info">
                <h3>{{ taux_presence }}%</h3>
                <p>Taux de présence</p>
            </div>
        </div>

        <div class="stat-card payments">
            <div class="stat-icon payments">
                <i class="fas fa-credit-card"></i>
            </div>
            <div class="stat-info">
                <h3>{{ statut_paiement }}</h3>
                <p>Statut paiement</p>
            </div>
        </div>
    </div>

    <!-- Prochain cours -->
    {% if prochain_cours %}
    <div class="next-course-card">
        <div class="card-header" style="background: transparent; border: none; color: white;">
            <h3 class="card-title" style="color: white;">
                <i class="fas fa-clock"></i>
                Prochain cours
            </h3>
        </div>
        <div class="next-course">
            <div class="course-info">
                <h4>{{ prochain_cours.cours.matiere.nom }}</h4>
                <p>
                    <i class="fas fa-calendar"></i>
                    {{ prochain_cours.date_prevue|date:"l d F Y" }} à {{ prochain_cours.date_prevue|time:"H:i" }}
                </p>
                <p>
                    <i class="fas fa-map-marker-alt"></i>
                    Salle {{ prochain_cours.salle.nom }}
                </p>
                <p>
                    <i class="fas fa-user"></i>
                    {{ prochain_cours.cours.enseignant.get_full_name }}
                </p>
            </div>
            <div class="course-actions">
                <span class="badge {% if prochain_cours.date_prevue.date == today %}badge-today{% else %}badge-upcoming{% endif %}">
                    {% if prochain_cours.date_prevue.date == today %}
                        Aujourd'hui
                    {% else %}
                        Dans {{ prochain_cours.date_prevue|timeuntil }}
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="dashboard-grid">
        <!-- Mes cours récents -->
        <div class="content-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-book"></i>
                    Mes cours récents
                </h3>
                <a href="{% url 'dashboard:student_courses' %}" class="btn btn-outline">
                    Voir tout
                </a>
            </div>
            <div class="card-body">
                {% if mes_cours %}
                <div class="course-list">
                    {% for cours in mes_cours %}
                    <div class="course-item">
                        <div class="course-icon">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div class="course-details">
                            <h5>{{ cours.matiere.nom }}</h5>
                            <p class="text-muted">{{ cours.enseignant.get_full_name }}</p>
                        </div>
                        <div class="course-progress">
                            <div class="progress">
                                <div class="progress-bar" style="width: 65%"></div>
                            </div>
                            <span>65%</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-book-open"></i>
                    <p>Aucun cours assigné pour le moment.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Évaluations à venir -->
        <div class="content-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-edit"></i>
                    Évaluations à venir
                </h3>
                <a href="{% url 'dashboard:student_evaluations' %}" class="btn btn-outline">
                    Voir tout
                </a>
            </div>
            <div class="card-body">
                {% if evaluations_a_venir %}
                <div class="evaluation-list">
                    {% for eval in evaluations_a_venir %}
                    <div class="evaluation-item">
                        <div class="eval-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="eval-details">
                            <h6>{{ eval.titre }}</h6>
                            <p class="text-muted">{{ eval.cours.matiere.nom }}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar"></i>
                                {{ eval.date_evaluation|date:"d/m/Y H:i" }}
                            </small>
                        </div>
                        <div class="eval-status">
                            <span class="badge badge-warning">À venir</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-edit"></i>
                    <p>Aucune évaluation à venir.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Dernières notes -->
        <div class="content-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    Dernières notes
                </h3>
                <a href="{% url 'dashboard:student_resultats' %}" class="btn btn-outline">
                    Voir tout
                </a>
            </div>
            <div class="card-body">
                {% if dernieres_notes %}
                <div class="grades-list">
                    {% for note in dernieres_notes %}
                    <div class="grade-item">
                        <div class="grade-subject">
                            <strong>{{ note.evaluation.cours.matiere.nom }}</strong>
                            <small>{{ note.evaluation.titre }}</small>
                        </div>
                        <div class="grade-value">
                            <span class="badge {% if note.valeur >= 10 %}badge-success{% else %}badge-danger{% endif %}">
                                {{ note.valeur }}/20
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-chart-bar"></i>
                    <p>Aucune note publiée.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Paiements -->
        <div class="content-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-credit-card"></i>
                    Situation financière
                </h3>
                <a href="#mes_paiements" class="btn btn-outline">
                    Détails
                </a>
            </div>
            <div class="card-body">
                {% if inscription_paiement %}
                <div class="payment-status">
                    <div class="payment-progress">
                        <div class="progress">
                            <div class="progress-bar" style="width: {{ pourcentage_paye }}%"></div>
                        </div>
                        <div class="payment-info">
                            <span>Payé: {{ total_paye|floatformat:0 }} XOF</span>
                            <span>Reste: {{ reste_a_payer|floatformat:0 }} XOF</span>
                        </div>
                    </div>
                    <div class="payment-total">
                        <strong>Total: {{ inscription_paiement.montant_total_du|floatformat:0 }} XOF</strong>
                    </div>
                </div>

                {% if statut_financier.peut_payer_tranche %}
                <div class="text-center">
                    <form action="{% url 'payments:payer_prochaine_tranche' %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-credit-card me-2"></i>
                            Payer prochaine tranche
                        </button>
                    </form>
                </div>
                {% endif %}
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-credit-card"></i>
                    <p>Aucune information de paiement disponible.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Notifications récentes -->
        <div class="content-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-bell"></i>
                    Notifications récentes
                </h3>
            </div>
            <div class="card-body">
                {% if notifications %}
                <div class="notifications-list">
                    {% for notif in notifications %}
                    <div class="notification-item" style="display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f3f4;">
                        <div class="notif-icon" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; background: {{ notif.color }};">
                            <i class="{{ notif.icon }}"></i>
                        </div>
                        <div class="notif-content" style="flex-grow: 1;">
                            <h6 style="margin: 0 0 5px 0; color: #2c3e50; font-weight: 600;">{{ notif.title }}</h6>
                            <p style="margin: 0; color: #6c757d; font-size: 14px;">{{ notif.message }}</p>
                            <small style="color: #adb5bd;">{{ notif.timestamp|timesince }} ago</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-bell"></i>
                    <p>Aucune notification récente.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal d'inscription obligatoire -->
{% include 'components/inscription_modal.html' %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier si l'accès est autorisé
    const peutAcceder = {{ peut_acceder|yesno:"true,false" }};

    if (!peutAcceder) {
        // Configurer le modal selon le statut
        const statutModal = "{{ statut_modal|default:'inscription_requise' }}";
        const message = "{{ message_modal|default:'Inscription requise' }}";

        // Mettre à jour le contenu du modal
        updateModalContent(statutModal, {
            message: message,
            candidatures_approuvees: {{ candidatures_approuvees|default:0 }},
            paiements_en_cours: {{ paiements_en_cours|default:0 }}
        });

        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('inscriptionModal'));
        modal.show();

        // Empêcher la fermeture du modal
        document.getElementById('inscriptionModal').addEventListener('hide.bs.modal', function (e) {
            e.preventDefault();
        });
    }

    // Actualiser automatiquement si des paiements sont en cours
    {% if paiements_en_cours > 0 %}
    setTimeout(function() {
        window.location.reload();
    }, 30000); // Actualiser toutes les 30 secondes
    {% endif %}

    // Animation des cartes
    const cards = document.querySelectorAll('.stat-card, .content-card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px)';
        });

        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});

function updateModalContent(statut, data) {
    const modalContent = document.getElementById('modal-content');
    const btnInscription = document.getElementById('btn-inscription');
    const btnCandidater = document.getElementById('btn-candidater');

    switch(statut) {
        case 'paiement_en_cours':
            modalContent.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-hourglass-split text-info" style="font-size: 4rem;"></i>
                    <h4 class="mt-3 mb-3">Paiement en cours</h4>
                    <p class="text-muted mb-4">${data.message}</p>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Votre paiement est en cours de traitement.
                        Veuillez patienter quelques minutes.
                    </div>
                </div>
            `;
            btnInscription.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Actualiser';
            btnInscription.onclick = () => window.location.reload();
            btnCandidater.style.display = 'none';
            break;

        case 'aucune_candidature':
            modalContent.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-file-earmark-x text-warning" style="font-size: 4rem;"></i>
                    <h4 class="mt-3 mb-3">Candidature requise</h4>
                    <p class="text-muted mb-4">Vous devez d'abord soumettre une candidature.</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Aucune candidature approuvée trouvée.
                    </div>
                </div>
            `;
            btnInscription.style.display = 'none';
            btnCandidater.style.display = 'inline-block';
            btnCandidater.onclick = () => window.location.href = "{% url 'enrollment:candidature_create' %}";
            break;

        default: // inscription_requise
            modalContent.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-person-x text-warning" style="font-size: 4rem;"></i>
                    <h4 class="mt-3 mb-3">Finalisation d'inscription</h4>
                    <p class="text-muted mb-4">Pour accéder à votre tableau de bord, vous devez finaliser votre inscription.</p>
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>${data.candidatures_approuvees} candidature(s) approuvée(s)</strong>
                    </div>
                    <div class="alert alert-info">
                        <strong>Options disponibles :</strong>
                        <ul class="list-unstyled mt-2 mb-0">
                            <li><i class="bi bi-check text-success me-1"></i> Paiement unique (avec remise)</li>
                            <li><i class="bi bi-check text-success me-1"></i> Paiement échelonné</li>
                        </ul>
                    </div>
                </div>
            `;
            btnInscription.style.display = 'inline-block';
            btnInscription.onclick = () => window.location.href = "{% url 'payments:initier_inscription' %}";
            btnCandidater.style.display = 'none';
            break;
    }
}
</script>
{% endblock %}