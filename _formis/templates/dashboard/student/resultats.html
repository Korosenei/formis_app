{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block page_title %}Mes Résultats{% endblock %}

{% block content %}
<div class="student-resultats">
    <!-- Header -->
    <div class="page-header-compact">
        <div class="header-content">
            <div class="breadcrumb-nav">
                <span>Dashboard</span>
                <i class="fas fa-chevron-right"></i>
                <span>Étudiant</span>
                <i class="fas fa-chevron-right"></i>
                <span class="current">Résultats</span>
            </div>
            <h1>Mes Résultats</h1>
        </div>
        <div class="header-actions">
            <button class="btn btn-sm btn-primary" onclick="exporterResultats()">
                <i class="fas fa-download"></i> Exporter
            </button>
            <button class="btn btn-sm btn-info" onclick="imprimerBulletin()">
                <i class="fas fa-print"></i> Bulletin
            </button>
        </div>
    </div>

    <!-- Carte Moyenne Générale -->
    <div class="moyenne-generale-card">
        <div class="moyenne-icon">
            <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="moyenne-content">
            <h2>Moyenne Générale</h2>
            <div class="moyenne-value">{{ moyenne_generale|floatformat:2 }}<span>/20</span></div>
            <div class="moyenne-appreciation">
                {% if moyenne_generale >= 16 %}
                    <span class="appreciation excellent">Excellent</span>
                {% elif moyenne_generale >= 14 %}
                    <span class="appreciation bien">Bien</span>
                {% elif moyenne_generale >= 12 %}
                    <span class="appreciation assez-bien">Assez Bien</span>
                {% elif moyenne_generale >= 10 %}
                    <span class="appreciation passable">Passable</span>
                {% else %}
                    <span class="appreciation insuffisant">Insuffisant</span>
                {% endif %}
            </div>
        </div>
        <div class="moyenne-chart">
            <svg viewBox="0 0 100 100" class="circular-progress">
                <circle cx="50" cy="50" r="45" class="progress-bg"></circle>
                <circle cx="50" cy="50" r="45" class="progress-bar"
                        style="stroke-dasharray: {{ moyenne_generale|floatformat:0 }}; stroke-dashoffset: {{ moyenne_generale|floatformat:0 }}"></circle>
            </svg>
            <div class="chart-label">{{ moyenne_generale|floatformat:0 }}%</div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="filters-section">
        <form method="GET" class="filters-form">
            <div class="filter-group">
                <select name="matiere" class="form-select-sm" onchange="this.form.submit()">
                    <option value="">Toutes les matières</option>
                    {% for matiere in matieres %}
                        <option value="{{ matiere.id }}" {% if current_filters.matiere == matiere.id|stringformat:"s" %}selected{% endif %}>
                            {{ matiere.nom }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <!-- Résultats par matière -->
    <div class="matieres-grid">
        {% for matiere_data in matieres_moyennes %}
        <div class="matiere-card">
            <div class="matiere-header">
                <div class="matiere-info">
                    <h3>{{ matiere_data.matiere.nom }}</h3>
                    <span class="matiere-code">{{ matiere_data.matiere.code }}</span>
                </div>
                <div class="matiere-moyenne">
                    <span class="moyenne-value-sm">{{ matiere_data.moyenne|floatformat:2 }}</span>
                    <span class="moyenne-max">/20</span>
                </div>
            </div>

            <div class="matiere-progress">
                <div class="progress-bar-matiere">
                    <div class="progress-fill-matiere"
                         style="width: {% widthratio matiere_data.moyenne 20 100 %}%;
                                background: {% if matiere_data.moyenne >= 10 %}#10b981{% else %}#ef4444{% endif %}">
                    </div>
                </div>
                <span class="progress-percentage">{% widthratio matiere_data.moyenne 20 100 %}%</span>
            </div>

            <div class="matiere-details">
                <div class="detail-row">
                    <span><i class="fas fa-list-ol"></i> Évaluations</span>
                    <strong>{{ matiere_data.nb_evaluations }}</strong>
                </div>
                <div class="detail-row">
                    <span><i class="fas fa-star"></i> Coefficient</span>
                    <strong>{{ matiere_data.matiere.coefficient }}</strong>
                </div>
            </div>

            <button class="btn-expand" onclick="toggleMatiere({{ matiere_data.matiere.id }})">
                <i class="fas fa-chevron-down"></i> Voir les notes
            </button>

            <div class="notes-list" id="notes-{{ matiere_data.matiere.id }}" style="display: none;">
                {% for note in matiere_data.notes %}
                <div class="note-item">
                    <div class="note-info">
                        <span class="note-titre">{{ note.evaluation.titre }}</span>
                        <span class="note-type">{{ note.evaluation.get_type_evaluation_display }}</span>
                        <span class="note-date">{{ note.date_attribution|date:"d/m/Y" }}</span>
                    </div>
                    <div class="note-valeur">
                        <span class="note-chiffre">{{ note.valeur }}</span>
                        <span class="note-sur">/{{ note.note_sur }}</span>
                        <span class="note-coef">Coef. {{ note.evaluation.coefficient }}</span>
                    </div>
                </div>
                {% if note.commentaire %}
                <div class="note-commentaire">
                    <i class="fas fa-comment-alt"></i>
                    {{ note.commentaire }}
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% empty %}
        <div class="empty-state-full">
            <i class="fas fa-chart-line fa-3x"></i>
            <h3>Aucun résultat</h3>
            <p>Vous n'avez pas encore de notes enregistrées</p>
        </div>
        {% endfor %}
    </div>

    <!-- Tableau détaillé des notes -->
    <div class="notes-table-section">
        <div class="section-header">
            <h3><i class="fas fa-table"></i> Toutes mes notes</h3>
        </div>

        <div class="table-wrapper">
            <table class="notes-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Matière</th>
                        <th>Évaluation</th>
                        <th>Type</th>
                        <th>Note</th>
                        <th>Note /20</th>
                        <th>Coef.</th>
                        <th>Enseignant</th>
                    </tr>
                </thead>
                <tbody>
                    {% for note in notes %}
                    <tr>
                        <td>{{ note.date_attribution|date:"d/m/Y" }}</td>
                        <td><strong>{{ note.matiere.nom }}</strong></td>
                        <td>{{ note.evaluation.titre }}</td>
                        <td>
                            <span class="type-badge {{ note.evaluation.type_evaluation|lower }}">
                                {{ note.evaluation.get_type_evaluation_display }}
                            </span>
                        </td>
                        <td>
                            <span class="note-badge {% if note.valeur >= note.note_sur|floatformat:0|add:'-4' %}success{% elif note.valeur >= note.note_sur|floatformat:0|add:'-10' %}warning{% else %}danger{% endif %}">
                                {{ note.valeur }}/{{ note.note_sur }}
                            </span>
                        </td>
                        <td><strong>{{ note.note_sur_20|floatformat:2 }}</strong></td>
                        <td>{{ note.evaluation.coefficient }}</td>
                        <td>{{ note.attribuee_par.get_full_name }}</td>
                    </tr>
                    {% if note.commentaire %}
                    <tr class="note-comment-row">
                        <td colspan="8">
                            <div class="table-comment">
                                <i class="fas fa-comment-dots"></i>
                                {{ note.commentaire }}
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            Aucune note disponible
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% include 'components/pagination.html' with page_obj=page_obj %}
</div>

<style>
.student-resultats { padding: 15px; max-width: 1400px; margin: 0 auto; }

.page-header-compact {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.breadcrumb-nav {
    font-size: 11px;
    color: #6b7280;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.breadcrumb-nav .current { color: #2563eb; font-weight: 500; }

.header-content h1 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #1f2937;
}

.header-actions { display: flex; gap: 8px; }

.btn {
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s;
}

.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn-primary { background: #2563eb; color: white; }
.btn-primary:hover { background: #1d4ed8; }
.btn-info { background: #3b82f6; color: white; }
.btn-info:hover { background: #2563eb; }

.moyenne-generale-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 30px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    color: white;
}

.moyenne-icon {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
}

.moyenne-content { flex: 1; }

.moyenne-content h2 {
    margin: 0 0 10px 0;
    font-size: 16px;
    font-weight: 500;
    opacity: 0.9;
}

.moyenne-value {
    font-size: 48px;
    font-weight: 700;
    margin-bottom: 10px;
}

.moyenne-value span {
    font-size: 24px;
    opacity: 0.8;
}

.moyenne-appreciation {
    display: inline-block;
}

.appreciation {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.2);
}

.moyenne-chart {
    position: relative;
    width: 120px;
    height: 120px;
}

.circular-progress {
    transform: rotate(-90deg);
}

.progress-bg {
    fill: none;
    stroke: rgba(255, 255, 255, 0.2);
    stroke-width: 8;
}

.progress-bar {
    fill: none;
    stroke: white;
    stroke-width: 8;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s;
}

.chart-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    font-weight: 700;
}

.filters-section {
    background: white;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.filters-form { display: flex; gap: 10px; }

.form-select-sm {
    padding: 6px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 13px;
}

.matieres-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.matiere-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s;
}

.matiere-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.matiere-header {
    padding: 20px;
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.matiere-info h3 {
    margin: 0 0 5px 0;
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
}

.matiere-code {
    font-size: 11px;
    color: #6b7280;
    font-weight: 500;
}

.matiere-moyenne {
    display: flex;
    align-items: baseline;
    gap: 3px;
}

.moyenne-value-sm {
    font-size: 28px;
    font-weight: 700;
    color: #2563eb;
}

.moyenne-max {
    font-size: 14px;
    color: #6b7280;
}

.matiere-progress {
    padding: 15px 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.progress-bar-matiere {
    flex: 1;
    height: 10px;
    background: #e5e7eb;
    border-radius: 5px;
    overflow: hidden;
}

.progress-fill-matiere {
    height: 100%;
    border-radius: 5px;
    transition: width 0.5s;
}

.progress-percentage {
    font-size: 13px;
    font-weight: 600;
    color: #6b7280;
    min-width: 40px;
}

.matiere-details {
    padding: 15px 20px;
    border-top: 1px solid #f3f4f6;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 13px;
}

.detail-row span {
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 6px;
}

.detail-row strong {
    color: #1f2937;
}

.btn-expand {
    width: 100%;
    padding: 12px;
    border: none;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: #2563eb;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.3s;
}

.btn-expand:hover {
    background: #f3f4f6;
}

.btn-expand i {
    transition: transform 0.3s;
}

.btn-expand.active i {
    transform: rotate(180deg);
}

.notes-list {
    padding: 15px;
    background: #fafbfc;
    border-top: 1px solid #e5e7eb;
}

.note-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: white;
    border-radius: 6px;
    margin-bottom: 10px;
    border: 1px solid #e5e7eb;
}

.note-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.note-titre {
    font-weight: 600;
    font-size: 14px;
    color: #1f2937;
}

.note-type {
    font-size: 11px;
    padding: 2px 8px;
    background: #f3f4f6;
    border-radius: 8px;
    display: inline-block;
    width: fit-content;
    color: #6b7280;
}

.note-date {
    font-size: 11px;
    color: #9ca3af;
}

.note-valeur {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
}

.note-chiffre {
    font-size: 24px;
    font-weight: 700;
    color: #2563eb;
}

.note-sur {
    font-size: 12px;
    color: #6b7280;
}

.note-coef {
    font-size: 10px;
    color: #9ca3af;
}

.note-commentaire {
    padding: 10px;
    background: #eff6ff;
    border-left: 3px solid #2563eb;
    border-radius: 4px;
    font-size: 12px;
    color: #1e40af;
    margin-bottom: 10px;
    display: flex;
    gap: 8px;
}

.note-commentaire i {
    margin-top: 2px;
}

.notes-table-section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 20px;
}

.section-header {
    padding: 15px 20px;
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
    border-bottom: 1px solid #e5e7eb;
}

.section-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 8px;
}

.table-wrapper {
    overflow-x: auto;
    padding: 20px;
}

.notes-table {
    width: 100%;
    border-collapse: collapse;
}

.notes-table thead th {
    background: #f9fafb;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    color: #6b7280;
    border-bottom: 2px solid #e5e7eb;
    text-transform: uppercase;
}

.notes-table tbody td {
    padding: 15px 12px;
    border-bottom: 1px solid #f3f4f6;
    font-size: 13px;
    color: #1f2937;
}

.notes-table tbody tr:hover {
    background: #fafbfc;
}

.type-badge {
    padding: 4px 10px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
    display: inline-block;
}

.type-badge.devoir { background: #dbeafe; color: #1e40af; }
.type-badge.composition { background: #fef3c7; color: #92400e; }
.type-badge.tp { background: #d1fae5; color: #065f46; }
.type-badge.projet { background: #e0e7ff; color: #3730a3; }
.type-badge.examen { background: #fee2e2; color: #991b1b; }
.type-badge.quiz { background: #e0e7ff; color: #3730a3; }

.note-badge {
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    display: inline-block;
}

.note-badge.success { background: #d1fae5; color: #065f46; }
.note-badge.warning { background: #fef3c7; color: #92400e; }
.note-badge.danger { background: #fee2e2; color: #991b1b; }

.note-comment-row td {
    padding: 0 !important;
    border-bottom: 1px solid #f3f4f6 !important;
}

.table-comment {
    padding: 10px 12px;
    background: #eff6ff;
    font-size: 12px;
    color: #1e40af;
    display: flex;
    gap: 8px;
    align-items: flex-start;
}

.table-comment i {
    margin-top: 2px;
    color: #2563eb;
}

.text-center { text-align: center; }
.text-muted { color: #6b7280; }

.empty-state-full {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.empty-state-full i { color: #d1d5db; margin-bottom: 20px; }
.empty-state-full h3 { margin: 0 0 10px 0; color: #1f2937; font-size: 18px; }
.empty-state-full p { margin: 0; color: #6b7280; font-size: 14px; }

@media (max-width: 1024px) {
    .matieres-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
}

@media (max-width: 768px) {
    .moyenne-generale-card {
        flex-direction: column;
        text-align: center;
    }

    .moyenne-chart {
        width: 100px;
        height: 100px;
    }

    .matieres-grid {
        grid-template-columns: 1fr;
    }

    .table-wrapper {
        overflow-x: scroll;
    }
}
</style>

<script>
function toggleMatiere(matiereId) {
    const notesList = document.getElementById(`notes-${matiereId}`);
    const button = event.currentTarget;

    if (notesList.style.display === 'none') {
        notesList.style.display = 'block';
        button.classList.add('active');
        button.innerHTML = '<i class="fas fa-chevron-up"></i> Masquer les notes';
    } else {
        notesList.style.display = 'none';
        button.classList.remove('active');
        button.innerHTML = '<i class="fas fa-chevron-down"></i> Voir les notes';
    }
}

function exporterResultats() {
    window.location.href = '{% url "evaluations:mes_notes" %}?export=pdf';
}

function imprimerBulletin() {
    window.print();
}

// Animation de la progression circulaire
document.addEventListener('DOMContentLoaded', function() {
    const moyenneGenerale = {{ moyenne_generale|floatformat:2 }};
    const circumference = 2 * Math.PI * 45;
    const offset = circumference - (moyenneGenerale / 20) * circumference;

    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.strokeDasharray = circumference;
        progressBar.style.strokeDashoffset = circumference;

        setTimeout(() => {
            progressBar.style.strokeDashoffset = offset;
        }, 100);
    }
});
</script>
{% endblock %}