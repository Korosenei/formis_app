{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block page_title %}Notes & Résultats - Apprenant{% endblock %}
{% block breadcrumb %}Notes & Résultats{% endblock %}

{% block content %}
<div class="grades-page">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-chart-line"></i>
            Notes & Résultats
        </h1>
        <div class="grade-actions">
            <button class="btn btn-outline" onclick="exportGrades()">
                <i class="fas fa-download"></i> Exporter
            </button>
            <button class="btn btn-primary" onclick="printGrades()">
                <i class="fas fa-print"></i> Imprimer
            </button>
        </div>
    </div>

    <!-- Statistiques générales -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="stat-info">
                <h3>{{ moyenne_generale|default:"0.00" }}/20</h3>
                <p>Moyenne générale</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon {% if note_max and note_max >= 10 %}success{% else %}warning{% endif %}">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="stat-info">
                <h3>{{ note_max|default:"-" }}/20</h3>
                <p>Meilleure note</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon {% if note_min and note_min >= 10 %}success{% else %}danger{% endif %}">
                <i class="fas fa-arrow-down"></i>
            </div>
            <div class="stat-info">
                <h3>{{ note_min|default:"-" }}/20</h3>
                <p>Moins bonne note</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon info">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_notes|default:"0" }}</h3>
                <p>Notes publiées</p>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="filters-section">
        <div class="filter-group">
            <label>Matière:</label>
            <select class="form-control" onchange="filterBySubject(this.value)">
                <option value="">Toutes les matières</option>
                {% for matiere in notes_par_matiere.keys %}
                <option value="{{ matiere }}">{{ matiere }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label>Période:</label>
            <select class="form-control" onchange="filterByPeriod(this.value)">
                <option value="">Toutes les périodes</option>
                <option value="semestre1">Semestre 1</option>
                <option value="semestre2">Semestre 2</option>
                <option value="annuel">Annuel</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Trier par:</label>
            <select class="form-control" onchange="sortGrades(this.value)">
                <option value="date_desc">Date (récent)</option>
                <option value="date_asc">Date (ancien)</option>
                <option value="note_desc">Note (élevée)</option>
                <option value="note_asc">Note (basse)</option>
                <option value="matiere">Matière</option>
            </select>
        </div>
    </div>

    <!-- Notes par matière -->
    <div class="subjects-grades">
        {% for matiere, notes in notes_par_matiere.items %}
        <div class="subject-card" data-matiere="{{ matiere }}">
            <div class="subject-header">
                <h3>{{ matiere }}</h3>
                <div class="subject-average">
                    {% with moyenne=notes|dictsort:"valeur"|slice:":1"|first %}
                    <span class="average-badge">
                        Moyenne: {{ notes.0.moyenne_matiere|default:"-" }}/20
                    </span>
                    {% endwith %}
                </div>
            </div>
            
            <div class="grades-list">
                {% for note in notes %}
                <div class="grade-item">
                    <div class="grade-info">
                        <h5>{{ note.evaluation.titre }}</h5>
                        <p class="text-muted">
                            {{ note.evaluation.date_evaluation|date:"d/m/Y" }} 
                            • Coefficient: {{ note.evaluation.coefficient }}
                        </p>
                    </div>
                    
                    <div class="grade-value">
                        <span class="grade-badge {% if note.valeur >= 10 %}good{% else %}bad{% endif %}">
                            {{ note.valeur }}/20
                        </span>
                    </div>
                    
                    <div class="grade-actions">
                        <button class="btn btn-sm btn-outline" onclick="viewGradeDetails({{ note.id }})">
                            <i class="fas fa-chart-bar"></i> Détails
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="subject-progress">
                <div class="progress">
                    <div class="progress-bar" 
                         style="width: {{ notes.0.moyenne_matiere|default:0|floatformat:0 }}%">
                    </div>
                </div>
                <div class="progress-label">
                    <span>Progression: {{ notes.0.moyenne_matiere|default:0|floatformat:1 }}/20</span>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="fas fa-chart-line fa-3x"></i>
            <h3>Aucune note disponible</h3>
            <p>Vos notes apparaîtront ici une fois publiées par vos enseignants.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Graphique des performances -->
    <div class="performance-chart">
        <div class="content-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Évolution des notes
                </h3>
            </div>
            <div class="card-body">
                <canvas id="gradesChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Tableau récapitulatif -->
    <div class="summary-table">
        <div class="content-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-table"></i>
                    Récapitulatif par matière
                </h3>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Matière</th>
                            <th>Notes</th>
                            <th>Moyenne</th>
                            <th>Coefficient</th>
                            <th>Rang</th>
                            <th>Appréciation</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for matiere, notes in notes_par_matiere.items %}
                        <tr>
                            <td>{{ matiere }}</td>
                            <td>{{ notes|length }}</td>
                            <td>
                                <span class="grade-badge {% if notes.0.moyenne_matiere >= 10 %}good{% else %}bad{% endif %}">
                                    {{ notes.0.moyenne_matiere|default:"-" }}/20
                                </span>
                            </td>
                            <td>{{ notes.0.evaluation.cours.matiere.coefficient|default:"-" }}</td>
                            <td>{{ notes.0.rang_matiere|default:"-" }}/{{ notes.0.effectif_matiere|default:"-" }}</td>
                            <td>
                                <span class="appreciation {% if notes.0.moyenne_matiere >= 10 %}good{% else %}bad{% endif %}">
                                    {{ notes.0.appreciation|default:"-" }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.grades-page {
    padding: 20px;
}

.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
}

.stat-icon.primary { background: #4e73df; }
.stat-icon.success { background: #1cc88a; }
.stat-icon.warning { background: #f6c23e; }
.stat-icon.danger { background: #e74a3b; }
.stat-icon.info { background: #36b9cc; }

.filters-section {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: 600;
    color: #2c3e50;
}

.subjects-grades {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

.subject-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.subject-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.subject-header h3 {
    margin: 0;
    color: #2c3e50;
}

.average-badge {
    background: #e3f2fd;
    color: #1976d2;
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: 600;
}

.grades-list {
    margin-bottom: 20px;
}

.grade-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #4e73df;
}

.grade-info h5 {
    margin: 0 0 5px;
    color: #2c3e50;
}

.grade-badge {
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 1.1em;
}

.grade-badge.good {
    background: #d4edda;
    color: #155724;
}

.grade-badge.bad {
    background: #f8d7da;
    color: #721c24;
}

.subject-progress {
    margin-top: 15px;
}

.progress-label {
    display: flex;
    justify-content: space-between;
    margin-top: 5px;
    font-size: 0.9em;
    color: #6c757d;
}

.performance-chart, .summary-table {
    margin-bottom: 30px;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th, .table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
}

.appreciation {
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.9em;
    font-weight: 500;
}

.appreciation.good {
    background: #d4edda;
    color: #155724;
}

.appreciation.bad {
    background: #f8d7da;
    color: #721c24;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function filterBySubject(subject) {
    document.querySelectorAll('.subject-card').forEach(card => {
        if (!subject || card.dataset.matiere === subject) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function filterByPeriod(period) {
    // Implémenter le filtrage par période
    console.log('Filtrage par période:', period);
}

function sortGrades(criteria) {
    // Implémenter le tri des notes
    console.log('Tri par:', criteria);
}

function viewGradeDetails(noteId) {
    // Implémenter l'affichage des détails de la note
    alert('Détails de la note ID: ' + noteId);
}

function exportGrades() {
    // Implémenter l'export des notes
    alert('Export des notes à implémenter');
}

function printGrades() {
    window.print();
}

// Graphique des performances
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('gradesChart').getContext('2d');
    const gradesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun'],
            datasets: [{
                label: 'Moyenne par mois',
                data: [12, 14, 11, 15, 13, 16],
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Évolution de votre moyenne'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 20,
                    title: {
                        display: true,
                        text: 'Note /20'
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}