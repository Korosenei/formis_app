{% extends 'base/dashboard_base.html' %}
{% load static %}
{% load humanize %}

{% block page_title %}Exercices comptables{% endblock %}

{% block breadcrumb %}
Dashboard > Comptabilité > Exercices comptables
{% endblock %}

{% block extra_css %}
<style>
.exercices-page {
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.page-title {
    font-size: 28px;
    font-weight: 700;
    color: #1e293b;
}

.header-actions {
    display: flex;
    gap: 12px;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    text-decoration: none;
    border: none;
    cursor: pointer;
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

.btn-secondary {
    background: white;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

.btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

/* Exercice actuel */
.exercice-actuel {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.exercice-actuel-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.exercice-actuel-title {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 8px 0;
}

.exercice-actuel-dates {
    font-size: 16px;
    opacity: 0.9;
}

.exercice-actuel-badge {
    padding: 8px 16px;
    background: rgba(255,255,255,0.2);
    border-radius: 8px;
    font-weight: 600;
}

.exercice-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.exercice-stat {
    background: rgba(255,255,255,0.15);
    padding: 20px;
    border-radius: 10px;
}

.exercice-stat-label {
    font-size: 13px;
    opacity: 0.9;
    margin-bottom: 8px;
}

.exercice-stat-value {
    font-size: 24px;
    font-weight: 700;
}

.exercice-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
}

/* Exercices grid */
.exercices-grid {
    display: grid;
    gap: 20px;
}

.exercice-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 4px solid;
}

.exercice-card.actif { border-color: #10b981; }
.exercice-card.cloture { border-color: #64748b; }

.exercice-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.exercice-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.exercice-info h3 {
    font-size: 20px;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 8px 0;
}

.exercice-dates {
    font-size: 14px;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 8px;
}

.badge {
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-actif {
    background: #d1fae5;
    color: #065f46;
}

.badge-cloture {
    background: #f1f5f9;
    color: #475569;
}

.exercice-stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    padding: 20px 0;
    border-top: 1px solid #f1f5f9;
    border-bottom: 1px solid #f1f5f9;
    margin-bottom: 20px;
}

.stat-item {
    text-align: center;
}

.stat-item-label {
    font-size: 12px;
    color: #64748b;
    margin-bottom: 6px;
}

.stat-item-value {
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
}

.exercice-card-actions {
    display: flex;
    gap: 10px;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 14px;
}

.btn-outline {
    background: white;
    border: 1px solid #e2e8f0;
    color: #64748b;
}

.btn-outline:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
}

/* Timeline */
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 30px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e2e8f0;
}

.timeline-item {
    position: relative;
    padding-left: 70px;
    margin-bottom: 30px;
}

.timeline-dot {
    position: absolute;
    left: 20px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    border: 3px solid #3b82f6;
    z-index: 1;
}

.timeline-dot.success {
    border-color: #10b981;
}

.timeline-dot.current {
    border-color: #f59e0b;
    box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
}

.timeline-content {
    background: white;
    padding: 16px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.timeline-date {
    font-size: 12px;
    color: #94a3b8;
    margin-bottom: 4px;
}

.timeline-title {
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
}

.timeline-desc {
    font-size: 14px;
    color: #64748b;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-title {
    font-size: 20px;
    font-weight: 600;
    color: #1e293b;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #94a3b8;
}

.modal-body {
    margin-bottom: 20px;
}

.modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: #1e293b;
    margin-bottom: 8px;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
}

.form-control:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.alert {
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-warning {
    background: #fef3c7;
    border: 1px solid #fcd34d;
    color: #92400e;
}

.alert-danger {
    background: #fee2e2;
    border: 1px solid #fca5a5;
    color: #991b1b;
}

@media (max-width: 768px) {
    .exercice-stats {
        grid-template-columns: 1fr;
    }

    .exercice-stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="exercices-page">
    <!-- En-tête -->
    <div class="page-header">
        <h1 class="page-title">Exercices comptables</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="showHelp()">
                <i class="fas fa-question-circle"></i>
                Aide
            </button>
            <button class="btn btn-primary" onclick="createExercice()">
                <i class="fas fa-plus"></i>
                Nouvel exercice
            </button>
        </div>
    </div>

    <!-- Exercice actuel -->
    {% if exercice_actuel %}
    <div class="exercice-actuel">
        <div class="exercice-actuel-header">
            <div>
                <h2 class="exercice-actuel-title">{{ exercice_actuel.libelle }}</h2>
                <div class="exercice-actuel-dates">
                    <i class="fas fa-calendar"></i>
                    {{ exercice_actuel.date_debut|date:"d/m/Y" }} - {{ exercice_actuel.date_fin|date:"d/m/Y" }}
                </div>
            </div>
            <span class="exercice-actuel-badge">
                <i class="fas fa-check-circle"></i>
                Exercice en cours
            </span>
        </div>

        <div class="exercice-stats">
            <div class="exercice-stat">
                <div class="exercice-stat-label">Écritures enregistrées</div>
                <div class="exercice-stat-value">{{ exercice_actuel.nb_ecritures|default:0 }}</div>
            </div>
            <div class="exercice-stat">
                <div class="exercice-stat-label">Total débits</div>
                <div class="exercice-stat-value">{{ exercice_actuel.total_debits|floatformat:0|intcomma }} FCFA</div>
            </div>
            <div class="exercice-stat">
                <div class="exercice-stat-label">Total crédits</div>
                <div class="exercice-stat-value">{{ exercice_actuel.total_credits|floatformat:0|intcomma }} FCFA</div>
            </div>
            <div class="exercice-stat">
                <div class="exercice-stat-label">Durée restante</div>
                <div class="exercice-stat-value">{{ exercice_actuel.jours_restants }} jours</div>
            </div>
        </div>

        <div class="exercice-actions">
            <button class="btn btn-secondary" onclick="viewDetails('{{ exercice_actuel.pk }}')">
                <i class="fas fa-eye"></i>
                Voir les détails
            </button>
            {% if not exercice_actuel.est_cloture %}
            <button class="btn btn-danger" onclick="clotureExercice('{{ exercice_actuel.pk }}')">
                <i class="fas fa-lock"></i>
                Clôturer l'exercice
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Liste des exercices -->
    <div style="margin-bottom: 20px;">
        <h3 style="font-size: 20px; font-weight: 600; color: #1e293b; margin-bottom: 20px;">
            Historique des exercices
        </h3>
    </div>

    <div class="exercices-grid">
        {% for exercice in exercices %}
        <div class="exercice-card {% if exercice.est_cloture %}cloture{% else %}actif{% endif %}">
            <div class="exercice-card-header">
                <div class="exercice-info">
                    <h3>{{ exercice.libelle }}</h3>
                    <div class="exercice-dates">
                        <i class="far fa-calendar"></i>
                        {{ exercice.date_debut|date:"d/m/Y" }} - {{ exercice.date_fin|date:"d/m/Y" }}
                        <span style="color: #94a3b8;">•</span>
                        {{ exercice.duree_jours }} jours
                    </div>
                </div>
                <span class="badge {% if exercice.est_cloture %}badge-cloture{% else %}badge-actif{% endif %}">
                    {% if exercice.est_cloture %}
                        <i class="fas fa-lock"></i> Clôturé
                    {% else %}
                        <i class="fas fa-unlock"></i> Actif
                    {% endif %}
                </span>
            </div>

            <div class="exercice-stats-grid">
                <div class="stat-item">
                    <div class="stat-item-label">Écritures</div>
                    <div class="stat-item-value">{{ exercice.nb_ecritures|default:0 }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">Débits</div>
                    <div class="stat-item-value" style="font-size: 16px;">
                        {{ exercice.total_debits|floatformat:0|intcomma }}
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">Crédits</div>
                    <div class="stat-item-value" style="font-size: 16px;">
                        {{ exercice.total_credits|floatformat:0|intcomma }}
                    </div>
                </div>
            </div>

            {% if exercice.est_cloture %}
            <div style="padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">
                    <i class="fas fa-calendar-check"></i>
                    Clôturé le {{ exercice.date_cloture|date:"d/m/Y à H:i" }}
                </div>
                {% if exercice.cloture_par %}
                <div style="font-size: 13px; color: #64748b;">
                    <i class="fas fa-user"></i>
                    Par {{ exercice.cloture_par.get_full_name }}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <div class="exercice-card-actions">
                <button class="btn btn-sm btn-outline" onclick="viewDetails('{{ exercice.pk }}')">
                    <i class="fas fa-eye"></i>
                    Détails
                </button>
                <button class="btn btn-sm btn-outline" onclick="exportExercice('{{ exercice.pk }}')">
                    <i class="fas fa-download"></i>
                    Exporter
                </button>
                {% if not exercice.est_cloture and exercice != exercice_actuel %}
                <button class="btn btn-sm btn-danger" onclick="clotureExercice('{{ exercice.pk }}')">
                    <i class="fas fa-lock"></i>
                    Clôturer
                </button>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
            <i class="fas fa-calendar-alt" style="font-size: 64px; color: #cbd5e1; margin-bottom: 20px;"></i>
            <h3 style="font-size: 20px; color: #64748b; margin-bottom: 10px;">Aucun exercice comptable</h3>
            <p style="color: #94a3b8; margin-bottom: 20px;">Créez votre premier exercice pour commencer la comptabilité</p>
            <button class="btn btn-primary" onclick="createExercice()">
                <i class="fas fa-plus"></i>
                Créer un exercice
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Timeline (optionnel) -->
    {% if exercices %}
    <div style="margin-top: 40px;">
        <h3 style="font-size: 20px; font-weight: 600; color: #1e293b; margin-bottom: 20px;">
            Chronologie des exercices
        </h3>
        <div class="timeline">
            {% for exercice in exercices %}
            <div class="timeline-item">
                <div class="timeline-dot {% if not exercice.est_cloture %}current{% else %}success{% endif %}"></div>
                <div class="timeline-content">
                    <div class="timeline-date">
                        {{ exercice.date_debut|date:"d/m/Y" }} - {{ exercice.date_fin|date:"d/m/Y" }}
                    </div>
                    <div class="timeline-title">{{ exercice.libelle }}</div>
                    <div class="timeline-desc">
                        {% if exercice.est_cloture %}
                            Clôturé le {{ exercice.date_cloture|date:"d/m/Y" }}
                        {% else %}
                            En cours • {{ exercice.jours_restants }} jours restants
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de clôture -->
<div id="clotureModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-lock"></i>
                Clôturer l'exercice
            </h3>
            <button class="modal-close" onclick="closeModal('clotureModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning">
                <strong><i class="fas fa-exclamation-triangle"></i> Attention !</strong><br>
                La clôture d'un exercice est définitive. Toutes les écritures seront verrouillées et ne pourront plus être modifiées.
            </div>

            <form id="clotureForm">
                {% csrf_token %}
                <div class="form-group">
                    <label class="form-label">Confirmation</label>
                    <input type="text" class="form-control" placeholder="Tapez 'CLOTURER' pour confirmer" id="confirmText">
                </div>

                <div class="form-group">
                    <label class="form-label">Notes (optionnel)</label>
                    <textarea class="form-control" rows="3" placeholder="Notes sur la clôture..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('clotureModal')">Annuler</button>
            <button class="btn btn-danger" onclick="confirmerCloture()">
                <i class="fas fa-lock"></i>
                Clôturer définitivement
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let exerciceEnCours = null;

function createExercice() {
    alert('Création d\'un nouvel exercice - Fonctionnalité à implémenter');
}

function viewDetails(exerciceId) {
    window.location.href = `/dashboard/comptable/exercices/${exerciceId}/`;
}

function exportExercice(exerciceId) {
    const format = prompt('Format d\'export (pdf/excel):', 'pdf');
    if (format) {
        window.location.href = `/dashboard/comptable/exercices/${exerciceId}/export/?format=${format}`;
    }
}

function clotureExercice(exerciceId) {
    exerciceEnCours = exerciceId;
    document.getElementById('clotureModal').classList.add('show');
    document.getElementById('confirmText').value = '';
}

function confirmerCloture() {
    const confirmText = document.getElementById('confirmText').value;

    if (confirmText !== 'CLOTURER') {
        alert('Veuillez taper exactement "CLOTURER" pour confirmer');
        return;
    }

    fetch(`{% url 'accounting:comptable_cloture_exercice' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', exerciceEnCours), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Exercice clôturé avec succès');
            closeModal('clotureModal');
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        alert('Erreur lors de la clôture: ' + error);
    });
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

function showHelp() {
    alert('Guide des exercices comptables:\n\n' +
          '1. Un exercice comptable correspond généralement à une année scolaire\n' +
          '2. Toutes les écritures doivent être rattachées à un exercice\n' +
          '3. La clôture d\'un exercice est définitive et verrouille toutes les écritures\n' +
          '4. Il est recommandé de clôturer l\'exercice avant d\'en créer un nouveau');
}

// Fermer modal en cliquant à l'extérieur
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
    }
}
</script>
{% endblock %}