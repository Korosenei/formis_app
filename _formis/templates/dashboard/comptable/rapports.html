{% extends 'base/dashboard_base.html' %}
{% load static %}
{% load humanize %}

{% block page_title %}Rapports financiers{% endblock %}

{% block breadcrumb %}
Dashboard > Comptabilité > Rapports
{% endblock %}

{% block extra_css %}
<style>
.rapports-page {
    padding: 20px;
}

.page-header {
    margin-bottom: 30px;
}

.page-title {
    font-size: 28px;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 10px;
}

.page-subtitle {
    color: #64748b;
    font-size: 15px;
}

/* Période Selection */
.periode-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.periode-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    align-items: end;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-size: 13px;
    font-weight: 500;
    color: #64748b;
    margin-bottom: 6px;
}

.form-control {
    padding: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

/* Rapports Grid */
.rapports-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.rapport-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
}

.rapport-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.rapport-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    margin-bottom: 16px;
}

.rapport-card.balance .rapport-icon {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.rapport-card.bilan .rapport-icon {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.rapport-card.resultat .rapport-icon {
    background: linear-gradient(135deg, #10b981, #059669);
}

.rapport-card.tresorerie .rapport-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.rapport-card.grand-livre .rapport-icon {
    background: linear-gradient(135deg, #06b6d4, #0891b2);
}

.rapport-card.journal .rapport-icon {
    background: linear-gradient(135deg, #ec4899, #db2777);
}

.rapport-title {
    font-size: 18px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 8px;
}

.rapport-description {
    font-size: 14px;
    color: #64748b;
    margin-bottom: 16px;
    line-height: 1.5;
}

.rapport-actions {
    display: flex;
    gap: 8px;
}

.btn-action {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    background: white;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.btn-action:hover {
    background: #f8fafc;
    border-color: #3b82f6;
    color: #3b82f6;
}

/* Résumé financier */
.resume-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.section-title {
    font-size: 20px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 20px;
}

.resume-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.resume-item {
    padding: 16px;
    border-radius: 8px;
    background: #f8fafc;
}

.resume-label {
    font-size: 13px;
    color: #64748b;
    margin-bottom: 8px;
}

.resume-value {
    font-size: 24px;
    font-weight: 700;
    color: #1e293b;
}

.resume-value.positive {
    color: #10b981;
}

.resume-value.negative {
    color: #ef4444;
}

.resume-detail {
    font-size: 13px;
    color: #64748b;
    margin-top: 4px;
}

/* Quick Stats */
.quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-box {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 4px solid;
}

.stat-box.recettes { border-color: #10b981; }
.stat-box.depenses { border-color: #ef4444; }
.stat-box.resultat { border-color: #3b82f6; }
.stat-box.tresorerie { border-color: #f59e0b; }

.stat-label {
    font-size: 13px;
    color: #64748b;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #1e293b;
}

.stat-evolution {
    font-size: 13px;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.stat-evolution.positive {
    color: #10b981;
}

.stat-evolution.negative {
    color: #ef4444;
}

@media (max-width: 768px) {
    .rapports-grid {
        grid-template-columns: 1fr;
    }

    .quick-stats {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="rapports-page">
    <!-- En-tête -->
    <div class="page-header">
        <h1 class="page-title">Rapports financiers</h1>
        <p class="page-subtitle">Consultez et exportez vos rapports comptables</p>
    </div>

    <!-- Sélection de période -->
    <div class="periode-card">
        <form method="get" class="periode-form">
            <div class="form-group">
                <label class="form-label">Date de début</label>
                <input type="date" name="date_debut" class="form-control"
                       value="{{ date_debut|date:'Y-m-d' }}" required>
            </div>

            <div class="form-group">
                <label class="form-label">Date de fin</label>
                <input type="date" name="date_fin" class="form-control"
                       value="{{ date_fin|date:'Y-m-d' }}" required>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sync"></i>
                    Actualiser
                </button>
            </div>
        </form>
    </div>

    <!-- Statistiques rapides -->
    <div class="quick-stats">
        <div class="stat-box recettes">
            <div class="stat-label">Recettes</div>
            <div class="stat-value">{{ rapport_recettes.total|floatformat:0|intcomma }} FCFA</div>
            <div class="stat-evolution positive">
                <i class="fas fa-arrow-up"></i>
                {{ rapport_recettes.nombre }} paiements
            </div>
        </div>

        <div class="stat-box depenses">
            <div class="stat-label">Dépenses</div>
            <div class="stat-value">{{ rapport_depenses.total|floatformat:0|intcomma }} FCFA</div>
            <div class="stat-evolution negative">
                <i class="fas fa-arrow-down"></i>
                {{ rapport_depenses.nombre }} dépenses
            </div>
        </div>

        <div class="stat-box resultat">
            <div class="stat-label">Résultat</div>
            {% with resultat=rapport_recettes.total|add:"-"|add:rapport_depenses.total %}
            <div class="stat-value {% if resultat >= 0 %}positive{% else %}negative{% endif %}">
                {{ resultat|floatformat:0|intcomma }} FCFA
            </div>
            {% endwith %}
        </div>

        <div class="stat-box tresorerie">
            <div class="stat-label">Trésorerie</div>
            <div class="stat-value">{{ rapport_tresorerie.solde_total|floatformat:0|intcomma }} FCFA</div>
            <div class="stat-evolution">
                Solde disponible
            </div>
        </div>
    </div>

    <!-- Résumé des impayés -->
    {% if rapport_impayes.nombre > 0 %}
    <div class="resume-section">
        <h3 class="section-title">
            <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
            Factures impayées
        </h3>
        <div class="resume-grid">
            <div class="resume-item">
                <div class="resume-label">Nombre de factures</div>
                <div class="resume-value">{{ rapport_impayes.nombre }}</div>
            </div>
            <div class="resume-item">
                <div class="resume-label">Montant total impayé</div>
                <div class="resume-value negative">{{ rapport_impayes.montant_total|floatformat:0|intcomma }} FCFA</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Grille des rapports -->
    <h3 class="section-title">Rapports disponibles</h3>
    <div class="rapports-grid">
        <!-- Balance générale -->
        <div class="rapport-card balance">
            <div class="rapport-icon">
                <i class="fas fa-balance-scale"></i>
            </div>
            <h3 class="rapport-title">Balance générale</h3>
            <p class="rapport-description">
                Vue d'ensemble de tous les comptes avec leurs débits, crédits et soldes
            </p>
            <div class="rapport-actions">
                <button class="btn-action" onclick="genererRapport('balance', 'view')">
                    <i class="fas fa-eye"></i>
                    Voir
                </button>
                <button class="btn-action" onclick="genererRapport('balance', 'pdf')">
                    <i class="fas fa-file-pdf"></i>
                    PDF
                </button>
                <button class="btn-action" onclick="genererRapport('balance', 'excel')">
                    <i class="fas fa-file-excel"></i>
                    Excel
                </button>
            </div>
        </div>

        <!-- Bilan -->
        <div class="rapport-card bilan">
            <div class="rapport-icon">
                <i class="fas fa-chart-pie"></i>
            </div>
            <h3 class="rapport-title">Bilan comptable</h3>
            <p class="rapport-description">
                Situation patrimoniale de l'établissement : actif et passif
            </p>
            <div class="rapport-actions">
                <button class="btn-action" onclick="genererRapport('bilan', 'view')">
                    <i class="fas fa-eye"></i>
                    Voir
                </button>
                <button class="btn-action" onclick="genererRapport('bilan', 'pdf')">
                    <i class="fas fa-file-pdf"></i>
                    PDF
                </button>
                <button class="btn-action" onclick="genererRapport('bilan', 'excel')">
                    <i class="fas fa-file-excel"></i>
                    Excel
                </button>
            </div>
        </div>

        <!-- Compte de résultat -->
        <div class="rapport-card resultat">
            <div class="rapport-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3 class="rapport-title">Compte de résultat</h3>
            <p class="rapport-description">
                Analyse des charges et produits sur la période
            </p>
            <div class="rapport-actions">
                <button class="btn-action" onclick="genererRapport('resultat', 'view')">
                    <i class="fas fa-eye"></i>
                    Voir
                </button>
                <button class="btn-action" onclick="genererRapport('resultat', 'pdf')">
                    <i class="fas fa-file-pdf"></i>
                    PDF
                </button>
                <button class="btn-action" onclick="genererRapport('resultat', 'excel')">
                    <i class="fas fa-file-excel"></i>
                    Excel
                </button>
            </div>
        </div>

        <!-- Trésorerie -->
        <div class="rapport-card tresorerie">
            <div class="rapport-icon">
                <i class="fas fa-coins"></i>
            </div>
            <h3 class="rapport-title">État de trésorerie</h3>
            <p class="rapport-description">
                Flux de trésorerie et soldes des comptes bancaires
            </p>
            <div class="rapport-actions">
                <button class="btn-action" onclick="genererRapport('tresorerie', 'view')">
                    <i class="fas fa-eye"></i>
                    Voir
                </button>
                <button class="btn-action" onclick="genererRapport('tresorerie', 'pdf')">
                    <i class="fas fa-file-pdf"></i>
                    PDF
                </button>
                <button class="btn-action" onclick="genererRapport('tresorerie', 'excel')">
                    <i class="fas fa-file-excel"></i>
                    Excel
                </button>
            </div>
        </div>

        <!-- Grand livre -->
        <div class="rapport-card grand-livre">
            <div class="rapport-icon">
                <i class="fas fa-book"></i>
            </div>
            <h3 class="rapport-title">Grand livre</h3>
            <p class="rapport-description">
                Détail de toutes les écritures par compte comptable
            </p>
            <div class="rapport-actions">
                <button class="btn-action" onclick="genererRapport('grand-livre', 'view')">
                    <i class="fas fa-eye"></i>
                    Voir
                </button>
                <button class="btn-action" onclick="genererRapport('grand-livre', 'pdf')">
                    <i class="fas fa-file-pdf"></i>
                    PDF
                </button>
            </div>
        </div>

        <!-- Journal -->
        <div class="rapport-card journal">
            <div class="rapport-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <h3 class="rapport-title">Journal comptable</h3>
            <p class="rapport-description">
                Registre chronologique de toutes les écritures
            </p>
            <div class="rapport-actions">
                <button class="btn-action" onclick="genererRapport('journal', 'view')">
                    <i class="fas fa-eye"></i>
                    Voir
                </button>
                <button class="btn-action" onclick="genererRapport('journal', 'pdf')">
                    <i class="fas fa-file-pdf"></i>
                    PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Informations supplémentaires -->
    <div class="resume-section">
        <h3 class="section-title">Informations complémentaires</h3>
        <div class="resume-grid">
            <div class="resume-item">
                <div class="resume-label">Période analysée</div>
                <div class="resume-value" style="font-size: 18px;">
                    {{ date_debut|date:"d/m/Y" }} - {{ date_fin|date:"d/m/Y" }}
                </div>
                <div class="resume-detail">
                    {{ date_debut|timesince:date_fin }}
                </div>
            </div>

            <div class="resume-item">
                <div class="resume-label">Taux de paiement</div>
                <div class="resume-value" style="font-size: 18px;">
                    {% widthratio rapport_recettes.nombre 100 100 %}%
                </div>
                <div class="resume-detail">
                    des factures émises
                </div>
            </div>

            <div class="resume-item">
                <div class="resume-label">Dépenses principales</div>
                <div class="resume-value" style="font-size: 16px;">
                    {% if rapport_depenses.par_categorie %}
                    {{ rapport_depenses.par_categorie.0.categorie }}
                    {% endif %}
                </div>
                <div class="resume-detail">
                    {% if rapport_depenses.par_categorie %}
                    {{ rapport_depenses.par_categorie.0.total|floatformat:0|intcomma }} FCFA
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function genererRapport(type, format) {
    const dateDebut = document.querySelector('input[name="date_debut"]').value;
    const dateFin = document.querySelector('input[name="date_fin"]').value;

    if (!dateDebut || !dateFin) {
        alert('Veuillez sélectionner une période');
        return;
    }

    let url = `{% url 'dashboard:comptable_rapports' %}`;

    // Routes spécifiques selon le type de rapport
    if (type === 'balance') {
        url = `{% url 'dashboard:comptable_rapport_balance' %}?date_debut=${dateDebut}&date_fin=${dateFin}&format=${format}`;
    } else if (type === 'bilan') {
        url = `{% url 'dashboard:comptable_rapport_bilan' %}?date_debut=${dateDebut}&date_fin=${dateFin}&format=${format}`;
    } else if (type === 'resultat') {
        url = `{% url 'dashboard:comptable_rapport_resultat' %}?date_debut=${dateDebut}&date_fin=${dateFin}&format=${format}`;
    } else if (type === 'tresorerie') {
        url = `{% url 'dashboard:comptable_rapport_tresorerie' %}?date_debut=${dateDebut}&date_fin=${dateFin}&format=${format}`;
    } else {
        url += `?type=${type}&date_debut=${dateDebut}&date_fin=${dateFin}&format=${format}`;
    }

    if (format === 'view') {
        window.location.href = url;
    } else {
        // Téléchargement direct pour PDF et Excel
        window.open(url, '_blank');
    }
}

// Raccourcis clavier
document.addEventListener('keydown', function(e) {
    // Ctrl + B pour Balance
    if (e.ctrlKey && e.key === 'b') {
        e.preventDefault();
        genererRapport('balance', 'view');
    }
    // Ctrl + R pour Résultat
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        genererRapport('resultat', 'view');
    }
});
</script>
{% endblock %}