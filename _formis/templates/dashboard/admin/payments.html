<!-- templates/dashboard/admin/payments.html -->
{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block page_title %}Gestion des Paiements - Admin{% endblock %}

{% block breadcrumb %}
Dashboard > Administration > Paiements
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css">
<link rel="stylesheet" href="/static/css/dashboard/admin-payments.css">
{% endblock %}

{% block content %}
<div class="admin-payments">
    <!-- Header avec statistiques financières -->
    <div class="financial-header">
        <div class="header-content">
            <div class="header-info">
                <h2>Gestion des Paiements</h2>
                <p>Suivi des recettes et gestion financière de l'établissement</p>
            </div>
            <div class="financial-stats">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ total_collecte|floatformat:0 }} FCFA</h3>
                        <p>Total collecté</p>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ paiements_en_attente }}</h3>
                        <p>En attente</p>
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ taux_recouvrement|floatformat:1 }}%</h3>
                        <p>Taux de recouvrement</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques et indicateurs -->
    <div class="analytics-section">
        <div class="analytics-grid">
            <div class="chart-card">
                <div class="card-header">
                    <h4>Évolution des recettes (12 mois)</h4>
                    <div class="card-controls">
                        <select class="period-selector" onchange="updateRevenueChart(this.value)">
                            <option value="monthly">Mensuel</option>
                            <option value="weekly">Hebdomadaire</option>
                            <option value="daily">Quotidien</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="payments-summary">
                <div class="summary-header">
                    <h4>Résumé des paiements</h4>
                </div>
                <div class="summary-stats">
                    <div class="summary-item">
                        <div class="summary-icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="summary-data">
                            <span class="number">{{ paiements_valides|default:0 }}</span>
                            <span class="label">Paiements validés</span>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="summary-data">
                            <span class="number">{{ paiements_en_attente }}</span>
                            <span class="label">En attente</span>
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-icon danger">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="summary-data">
                            <span class="number">{{ paiements_rejetes|default:0 }}</span>
                            <span class="label">Rejetés</span>
                        </div>
                    </div>
                </div>

                <!-- Actions rapides -->
                <div class="quick-actions">
                    <button class="action-btn" onclick="generatePaymentReport()">
                        <i class="fas fa-file-invoice-dollar"></i>
                        Rapport financier
                    </button>
                    <button class="action-btn" onclick="exportPayments()">
                        <i class="fas fa-download"></i>
                        Exporter données
                    </button>
                    <button class="action-btn" onclick="reconcilePayments()">
                        <i class="fas fa-balance-scale"></i>
                        Rapprochement
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres et recherche -->
    <div class="filters-section">
        <div class="filters-header">
            <h4>Filtrer les paiements</h4>
        </div>
        <form method="GET" class="filters-form">
            <div class="filters-row">
                <div class="filter-group">
                    <label>Rechercher</label>
                    <input type="text" name="search" placeholder="Nom étudiant, numéro transaction..."
                           value="{{ request.GET.search }}" class="form-input">
                </div>

                <div class="filter-group">
                    <label>Statut</label>
                    <select name="statut" class="form-select">
                        <option value="">Tous les statuts</option>
                        {% for statut_key, statut_label in statuts_paiement %}
                            <option value="{{ statut_key }}"
                                {% if request.GET.statut == statut_key %}selected{% endif %}>
                                {{ statut_label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label>Période</label>
                    <select name="periode" class="form-select">
                        <option value="">Toute période</option>
                        <option value="cette_semaine" {% if request.GET.periode == 'cette_semaine' %}selected{% endif %}>Cette semaine</option>
                        <option value="ce_mois" {% if request.GET.periode == 'ce_mois' %}selected{% endif %}>Ce mois</option>
                        <option value="ce_trimestre" {% if request.GET.periode == 'ce_trimestre' %}selected{% endif %}>Ce trimestre</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Montant</label>
                    <div class="amount-range">
                        <input type="number" name="montant_min" placeholder="Min" class="form-input-small">
                        <span>-</span>
                        <input type="number" name="montant_max" placeholder="Max" class="form-input-small">
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Filtrer</button>
                    <a href="{% url 'dashboard:admin_payments' %}" class="btn btn-outline">Reset</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Liste des paiements -->
    <div class="payments-table-section">
        <div class="table-header">
            <div class="table-title">
                <h4>Liste des paiements</h4>
                <span class="records-count">{{ payments|length }} sur {{ payments.paginator.count }} paiements</span>
            </div>
            <div class="table-actions">
                <button class="btn btn-sm btn-success" onclick="validateSelected()">
                    <i class="fas fa-check"></i> Valider sélection
                </button>
                <button class="btn btn-sm btn-danger" onclick="rejectSelected()">
                    <i class="fas fa-times"></i> Rejeter sélection
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="payments-table">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="selectAllPayments" class="select-all">
                        </th>
                        <th>Étudiant</th>
                        <th>Montant</th>
                        <th>Date</th>
                        <th>Méthode</th>
                        <th>Référence</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr class="payment-row" data-payment-id="{{ payment.id }}">
                        <td>
                            <input type="checkbox" class="payment-checkbox" value="{{ payment.id }}">
                        </td>
                        <td>
                            <div class="student-info">
                                <div class="student-name">{{ payment.apprenant.get_full_name }}</div>
                                <div class="student-matricule">{{ payment.apprenant.matricule }}</div>
                            </div>
                        </td>
                        <td>
                            <div class="amount-info">
                                <span class="amount">{{ payment.montant|floatformat:0 }} FCFA</span>
                                <span class="payment-type">{{ payment.type_paiement|default:"Frais de scolarité" }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="date-info">
                                <span class="date">{{ payment.date_paiement|date:"d/m/Y" }}</span>
                                <span class="time">{{ payment.date_paiement|time:"H:i" }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="method-info">
                                <span class="method">{{ payment.methode_paiement|default:"Espèces" }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="reference">
                                {% if payment.numero_transaction %}
                                    <code>{{ payment.numero_transaction }}</code>
                                {% else %}
                                    <span class="no-ref">Non disponible</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-{{ payment.statut|lower }}">
                                {{ payment.get_statut_display }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon btn-info"
                                        onclick="viewPaymentDetails('{{ payment.id }}')"
                                        title="Voir détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if payment.statut == 'EN_ATTENTE' %}
                                    <button class="btn-icon btn-success"
                                            onclick="validatePayment('{{ payment.id }}')"
                                            title="Valider">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn-icon btn-danger"
                                            onclick="rejectPayment('{{ payment.id }}')"
                                            title="Rejeter">
                                        <i class="fas fa-times"></i>
                                    </button>
                                {% endif %}
                                <div class="dropdown">
                                    <button class="btn-icon btn-outline dropdown-toggle">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-menu">
                                        <a href="#" onclick="printReceipt('{{ payment.id }}')">
                                            <i class="fas fa-print"></i> Imprimer reçu
                                        </a>
                                        <a href="#" onclick="sendReceipt('{{ payment.id }}')">
                                            <i class="fas fa-envelope"></i> Envoyer reçu
                                        </a>
                                        <a href="#" onclick="viewHistory('{{ payment.id }}')">
                                            <i class="fas fa-history"></i> Historique
                                        </a>
                                        {% if payment.statut == 'VALIDE' %}
                                        <div class="dropdown-divider"></div>
                                        <a href="#" onclick="refundPayment('{{ payment.id }}')" class="text-warning">
                                            <i class="fas fa-undo"></i> Rembourser
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-content">
                                <i class="fas fa-credit-card fa-3x"></i>
                                <h3>Aucun paiement trouvé</h3>
                                <p>Aucun paiement ne correspond aux critères sélectionnés.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if payments.has_other_pages %}
        <div class="pagination-container">
            <div class="pagination-info">
                Affichage de {{ payments.start_index }} à {{ payments.end_index }} sur {{ payments.paginator.count }} paiements
            </div>
            <nav class="pagination">
                {% if payments.has_previous %}
                    <a href="?page=1&{{ request.GET.urlencode }}" class="page-link">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ payments.previous_page_number }}&{{ request.GET.urlencode }}" class="page-link">
                        <i class="fas fa-angle-left"></i>
                    </a>
                {% endif %}

                {% for num in payments.paginator.page_range %}
                    {% if payments.number == num %}
                        <span class="page-link active">{{ num }}</span>
                    {% elif num > payments.number|add:'-3' and num < payments.number|add:'3' %}
                        <a href="?page={{ num }}&{{ request.GET.urlencode }}" class="page-link">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if payments.has_next %}
                    <a href="?page={{ payments.next_page_number }}&{{ request.GET.urlencode }}" class="page-link">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ payments.paginator.num_pages }}&{{ request.GET.urlencode }}" class="page-link">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<style>
.admin-payments {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.financial-header {
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    color: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.header-info h2 {
    margin: 0 0 8px 0;
    font-size: 28px;
    font-weight: 700;
}

.header-info p {
    margin: 0;
    opacity: 0.9;
    font-size: 16px;
}

.financial-stats {
    display: flex;
    gap: 25px;
}

.stat-card {
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    min-width: 180px;
    backdrop-filter: blur(10px);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
}

.stat-card.primary .stat-icon { background: rgba(78, 115, 223, 0.3); }
.stat-card.warning .stat-icon { background: rgba(246, 194, 62, 0.3); }
.stat-card.success .stat-icon { background: rgba(28, 200, 138, 0.3); }

.stat-info h3 {
    margin: 0 0 5px 0;
    font-size: 20px;
    font-weight: bold;
}

.stat-info p {
    margin: 0;
    opacity: 0.9;
    font-size: 14px;
}

.analytics-section {
    margin-bottom: 30px;
}

.analytics-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
}

.chart-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    overflow: hidden;
    height: 400px;
}

.card-header {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8fafc;
}

.card-header h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #2d3748;
}

.period-selector {
    padding: 6px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
}

.chart-container {
    padding: 20px;
    height: calc(100% - 80px);
}

.payments-summary {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    overflow: hidden;
}

.summary-header {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
}

.summary-header h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #2d3748;
}

.summary-stats {
    padding: 20px;
}

.summary-item {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.summary-icon {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
}

.summary-icon.success { background: #1cc88a; }
.summary-icon.warning { background: #f6c23e; }
.summary-icon.danger { background: #e74a3b; }

.summary-data .number {
    display: block;
    font-size: 20px;
    font-weight: bold;
    color: #2d3748;
}

.summary-data .label {
    font-size: 14px;
    color: #718096;
}

.quick-actions {
    padding: 20px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    color: #2d3748;
    font-size: 14px;
}

.action-btn:hover {
    background: #4e73df;
    color: white;
    border-color: #4e73df;
}

.filters-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    overflow: hidden;
}

.filters-header {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    background: #f8fafc;
}

.filters-header h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #2d3748;
}

.filters-form {
    padding: 20px;
}

.filters-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1.5fr auto;
    gap: 20px;
    align-items: end;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #2d3748;
    font-size: 14px;
}

.form-input, .form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: #4e73df;
    box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1);
}

.amount-range {
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-input-small {
    width: 80px;
    padding: 8px 10px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 13px;
}

.filter-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.btn {
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s;
    text-decoration: none;
    font-size: 14px;
}

.btn-primary {
    background: #4e73df;
    color: white;
}

.btn-outline {
    background: white;
    color: #4e73df;
    border: 1px solid #4e73df;
}

.payments-table-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    overflow: hidden;
}

.table-header {
    padding: 20px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.table-title h4 {
    margin: 0 0 5px 0;
    font-size: 18px;
    font-weight: 600;
    color: #2d3748;
}

.records-count {
    font-size: 13px;
    color: #718096;
}

.table-actions {
    display: flex;
    gap: 10px;
}

.btn-sm {
    padding: 8px 12px;
    font-size: 13px;
}

.btn-success {
    background: #1cc88a;
    color: white;
}

.btn-danger {
    background: #e74a3b;
    color: white;
}

.table-responsive {
    overflow-x: auto;
}

.payments-table {
    width: 100%;
    border-collapse: collapse;
}

.payments-table th {
    background: #f8fafc;
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    color: #2d3748;
    border-bottom: 2px solid #e2e8f0;
    font-size: 13px;
}

.payments-table td {
    padding: 15px 12px;
    border-bottom: 1px solid #f7fafc;
    vertical-align: middle;
}

.student-info .student-name {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 4px;
}

.student-info .student-matricule {
    font-size: 12px;
    color: #718096;
    font-family: monospace;
}

.amount-info .amount {
    font-weight: bold;
    color: #2d3748;
    display: block;
    margin-bottom: 2px;
}

.amount-info .payment-type {
    font-size: 12px;
    color: #718096;
}

.date-info .date {
    font-weight: 500;
    color: #2d3748;
    display: block;
}

.date-info .time {
    font-size: 12px;
    color: #718096;
}

.method-info .method {
    background: #edf2f7;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    color: #2d3748;
}

.reference code {
    background: #f7fafc;
    padding: 4px 8px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    color: #4a5568;
}

.no-ref {
    color: #a0aec0;
    font-style: italic;
    font-size: 12px;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-en_attente {
    background: #fff3cd;
    color: #856404;
}

.status-valide {
    background: #d4edda;
    color: #155724;
}

.status-rejete {
    background: #f8d7da;
    color: #721c24;
}

.action-buttons {
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-icon.btn-info {
    background: #36b9cc;
    color: white;
}

.btn-icon.btn-success {
    background: #1cc88a;
    color: white;
}

.btn-icon.btn-danger {
    background: #e74a3b;
    color: white;
}

.btn-icon.btn-outline {
    background: white;
    border: 1px solid #e2e8f0;
    color: #718096;
}

.dropdown {
    position: relative;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    min-width: 160px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    z-index: 1000;
    display: none;
}

.dropdown-menu a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    text-decoration: none;
    color: #2d3748;
    font-size: 14px;
    transition: background-color 0.3s;
}

.dropdown-menu a:hover {
    background: #f8fafc;
}

.dropdown-divider {
    height: 1px;
    background: #e2e8f0;
    margin: 8px 0;
}

.text-warning { color: #f6c23e; }

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-content i {
    color: #e2e8f0;
    margin-bottom: 20px;
}

.empty-content h3 {
    color: #718096;
    margin-bottom: 12px;
}

.empty-content p {
    color: #a0aec0;
}

.pagination-container {
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #e2e8f0;
}

.pagination-info {
    color: #718096;
    font-size: 14px;
}

.pagination {
    display: flex;
    gap: 5px;
}

.page-link {
    padding: 10px 14px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    color: #4e73df;
    text-decoration: none;
    transition: all 0.3s;
}

.page-link:hover {
    background: #4e73df;
    color: white;
}

.page-link.active {
    background: #4e73df;
    color: white;
    border-color: #4e73df;
}

@media (max-width: 1200px) {
    .analytics-grid {
        grid-template-columns: 1fr;
    }

    .financial-stats {
        flex-direction: column;
        gap: 15px;
    }
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 20px;
        text-align: center;
    }

    .filters-row {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .filter-actions {
        flex-direction: row;
    }

    .table-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }

    .payments-table {
        font-size: 13px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Graphique des revenus
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');

    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'],
            datasets: [{
                label: 'Revenus (FCFA)',
                data: [2500000, 3200000, 2800000, 3500000, 4100000, 3800000, 4200000, 3900000, 4300000, 4500000, 4800000, 5200000],
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#4e73df',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        label: function(context) {
                            return `Revenus: ${context.raw.toLocaleString()} FCFA`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    border: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    },
                    border: {
                        display: false
                    },
                    ticks: {
                        callback: function(value) {
                            return (value / 1000000).toFixed(1) + 'M';
                        }
                    }
                }
            }
        }
    });

    // Gestion des sélections multiples
    const selectAll = document.getElementById('selectAllPayments');
    const checkboxes = document.querySelectorAll('.payment-checkbox');

    selectAll.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // Gestion des dropdowns
    document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = this.nextElementSibling;
            const isVisible = dropdown.style.display === 'block';

            // Fermer tous les dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });

            // Toggle le dropdown actuel
            dropdown.style.display = isVisible ? 'none' : 'block';
        });
    });

    // Fermer les dropdowns au clic extérieur
    document.addEventListener('click', function() {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.style.display = 'none';
        });
    });
});

// Fonctions pour les actions
function updateRevenueChart(period) {
    // Mettre à jour le graphique selon la période
    console.log('Updating chart for period:', period);
}

function generatePaymentReport() {
    window.location.href = '/dashboard/admin/payments/reports/';
}

function exportPayments() {
    const params = new URLSearchParams(window.location.search);
    window.location.href = `/dashboard/admin/payments/export/?${params.toString()}`;
}

function reconcilePayments() {
    alert('Fonction de rapprochement bancaire à implémenter');
}

function viewPaymentDetails(paymentId) {
    window.location.href = `/dashboard/admin/payments/${paymentId}/`;
}

function validatePayment(paymentId) {
    if (confirm('Êtes-vous sûr de vouloir valider ce paiement ?')) {
        fetch(`/dashboard/admin/payments/${paymentId}/validate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur lors de la validation du paiement');
            }
        });
    }
}

function rejectPayment(paymentId) {
    const reason = prompt('Raison du rejet (optionnel):');
    if (reason !== null) {
        fetch(`/dashboard/admin/payments/${paymentId}/reject/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({reason: reason})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur lors du rejet du paiement');
            }
        });
    }
}

function validateSelected() {
    const selected = Array.from(document.querySelectorAll('.payment-checkbox:checked')).map(cb => cb.value);
    if (selected.length === 0) {
        alert('Veuillez sélectionner au moins un paiement');
        return;
    }

    if (confirm(`Êtes-vous sûr de vouloir valider ${selected.length} paiement(s) ?`)) {
        fetch('/dashboard/admin/payments/bulk-validate/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({payments: selected})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur lors de la validation des paiements');
            }
        });
    }
}

function rejectSelected() {
    const selected = Array.from(document.querySelectorAll('.payment-checkbox:checked')).map(cb => cb.value);
    if (selected.length === 0) {
        alert('Veuillez sélectionner au moins un paiement');
        return;
    }

    const reason = prompt('Raison du rejet (optionnel):');
    if (reason !== null) {
        fetch('/dashboard/admin/payments/bulk-reject/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({payments: selected, reason: reason})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur lors du rejet des paiements');
            }
        });
    }
}

function printReceipt(paymentId) {
    window.open(`/dashboard/admin/payments/${paymentId}/receipt/print/`, '_blank');
}

function sendReceipt(paymentId) {
    if (confirm('Envoyer le reçu par email à l\'étudiant ?')) {
        fetch(`/dashboard/admin/payments/${paymentId}/receipt/send/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Reçu envoyé avec succès');
            } else {
                alert('Erreur lors de l\'envoi du reçu');
            }
        });
    }
}

function viewHistory(paymentId) {
    window.location.href = `/dashboard/admin/payments/${paymentId}/history/`;
}

function refundPayment(paymentId) {
    const amount = prompt('Montant du remboursement (FCFA):');
    const reason = prompt('Raison du remboursement:');

    if (amount && reason) {
        if (confirm(`Confirmer le remboursement de ${amount} FCFA ?`)) {
            fetch(`/dashboard/admin/payments/${paymentId}/refund/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({amount: amount, reason: reason})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Remboursement traité avec succès');
                    location.reload();
                } else {
                    alert('Erreur lors du remboursement');
                }
            });
        }
    }
}

// Fonction utilitaire pour récupérer le token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}