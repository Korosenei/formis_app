{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block page_title %}Gestion des Chefs de Département - Admin{% endblock %}

{% block content %}
<div class="dept-heads-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-left">
            <div class="breadcrumb">
                <span>Dashboard</span>
                <i class="fas fa-chevron-right"></i>
                <span>Administration</span>
                <i class="fas fa-chevron-right"></i>
                <span class="active">Chefs de département</span>
            </div>
            <h1><i class="fas fa-crown"></i> Gestion des Chefs de Département</h1>
        </div>
        <div class="header-actions">
            {% if can_nominate %}
            <a href="{% url 'accounts:nominate_department_head' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Nommer un chef
            </a>
            {% else %}
            <button class="btn btn-secondary" disabled title="Tous les départements ont un chef">
                <i class="fas fa-check"></i> Tous nommés
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" id="msg-{{ forloop.counter }}">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
            {{ message }}
            <button onclick="closeAlert('msg-{{ forloop.counter }}')">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card blue">
            <div class="stat-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">{{ total_departements }}</div>
                <div class="stat-label">Départements</div>
            </div>
        </div>
        <div class="stat-card green">
            <div class="stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">{{ total_departements|add:"-"|add:departements_sans_chef }}</div>
                <div class="stat-label">Avec chef</div>
            </div>
        </div>
        <div class="stat-card orange">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <div class="stat-value">{{ departements_sans_chef }}</div>
                <div class="stat-label">Sans chef</div>
            </div>
        </div>
    </div>

    <!-- Liste départements -->
    <div class="depts-grid">
        {% for dept in chefs_departement %}
        <div class="dept-card {% if not dept.chef %}no-chef{% endif %}" id="dept-{{ dept.id }}">
            <div class="dept-header">
                <div class="dept-title">
                    <i class="fas fa-building"></i>
                    <h3>{{ dept.nom }}</h3>
                </div>
                <code class="dept-code">{{ dept.code }}</code>
            </div>

            <div class="dept-body">
                {% if dept.chef %}
                <div class="chef-info">
                    <div class="chef-avatar">
                        {% if dept.chef.photo_profil %}
                        <img src="{{ dept.chef.photo_profil.url }}" alt="">
                        {% else %}
                        <i class="fas fa-user-tie"></i>
                        {% endif %}
                    </div>
                    <div class="chef-details">
                        <div class="chef-name">
                            <i class="fas fa-crown"></i>
                            {{ dept.chef.get_full_name }}
                        </div>
                        <div class="chef-meta">
                            <span><i class="fas fa-id-badge"></i> {{ dept.chef.matricule }}</span>
                        </div>
                        <div class="chef-meta">
                            <span><i class="fas fa-envelope"></i> {{ dept.chef.email }}</span>
                        </div>
                        {% if dept.chef.telephone %}
                        <div class="chef-meta">
                            <span><i class="fas fa-phone"></i> {{ dept.chef.telephone }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="dept-actions">
                    <a href="{% url 'accounts:teacher_detail' dept.chef.id %}" class="btn-sm btn-outline">
                        <i class="fas fa-eye"></i> Profil
                    </a>
                    <button onclick="revoquerChef('{{ dept.id }}', '{{ dept.chef.get_full_name }}', '{{ dept.nom }}')"
                            class="btn-sm btn-danger">
                        <i class="fas fa-user-times"></i> Révoquer
                    </button>
                </div>
                {% else %}
                <div class="no-chef">
                    <div class="no-chef-icon">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <p>Aucun chef nommé</p>
                    <a href="{% url 'accounts:nominate_department_head' %}?dept={{ dept.id }}" class="btn-sm btn-primary">
                        <i class="fas fa-plus"></i> Nommer
                    </a>
                </div>
                {% endif %}
            </div>

            <div class="dept-footer">
                <span><i class="fas fa-chalkboard-teacher"></i> {{ dept.utilisateurs.count }} enseignants</span>
                <span><i class="fas fa-network-wired"></i> {{ dept.filieres.count }} filières</span>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="fas fa-building fa-3x"></i>
            <p>Aucun département trouvé</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="modalTitle"></h4>
            <button onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="modalMessage"></p>
            <div id="modalDetails" class="modal-details"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal()">Annuler</button>
            <button id="modalConfirm" class="btn btn-danger">Confirmer</button>
        </div>
    </div>
</div>

<style>
.dept-heads-page { padding: 20px; background: #f5f7fa; min-height: 100vh; }

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    margin-bottom: 20px;
}

.breadcrumb {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.breadcrumb .active { color: #2563eb; font-weight: 500; }

.page-header h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 12px;
}

.page-header h1 i { color: #f59e0b; }

.messages { margin-bottom: 20px; }

.alert {
    background: white;
    padding: 14px 18px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    animation: slideIn 0.3s;
}

@keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.alert-success {
    border-left: 4px solid #10b981;
    color: #065f46;
}

.alert-error {
    border-left: 4px solid #ef4444;
    color: #991b1b;
}

.alert button {
    margin-left: auto;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    opacity: 0.6;
}

.alert button:hover { opacity: 1; }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 55px;
    height: 55px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px;
    color: white;
}

.stat-card.blue .stat-icon { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
.stat-card.green .stat-icon { background: linear-gradient(135deg, #10b981, #059669); }
.stat-card.orange .stat-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
}

.stat-label {
    font-size: 13px;
    color: #6b7280;
    margin-top: 4px;
}

.depts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 20px;
}

.dept-card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    transition: all 0.3s;
    border: 2px solid transparent;
}

.dept-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.12);
}

.dept-card.no-chef {
    border-color: #fbbf24;
    background: #fffbeb;
}

.dept-header {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: white;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dept-card.no-chef .dept-header {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.dept-title {
    display: flex;
    align-items: center;
    gap: 10px;
}

.dept-title h3 {
    margin: 0;
    font-size: 17px;
    font-weight: 600;
}

.dept-code {
    background: rgba(255,255,255,0.2);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
}

.dept-body {
    padding: 20px;
    min-height: 200px;
    display: flex;
    flex-direction: column;
}

.chef-info {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex: 1;
}

.chef-avatar {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    font-size: 26px;
    border: 3px solid #e5e7eb;
    overflow: hidden;
    flex-shrink: 0;
}

.chef-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.chef-details {
    flex: 1;
}

.chef-name {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.chef-name i {
    color: #f59e0b;
}

.chef-meta {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 4px;
}

.chef-meta i {
    width: 16px;
}

.dept-actions {
    display: flex;
    gap: 8px;
}

.no-chef {
    text-align: center;
    padding: 40px 20px;
    color: #6b7280;
}

.no-chef-icon {
    font-size: 52px;
    color: #f59e0b;
    margin-bottom: 15px;
}

.no-chef p {
    margin: 0 0 15px 0;
    font-size: 15px;
}

.dept-footer {
    background: #f9fafb;
    padding: 12px 20px;
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #e5e7eb;
    font-size: 12px;
    color: #6b7280;
}

.dept-footer span {
    display: flex;
    align-items: center;
    gap: 6px;
}

.dept-footer i {
    color: #2563eb;
}

.btn, .btn-sm {
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    transition: all 0.3s;
}

.btn-sm {
    padding: 7px 14px;
    font-size: 12px;
}

.btn-primary {
    background: #2563eb;
    color: white;
}

.btn-primary:hover {
    background: #1d4ed8;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-outline {
    background: white;
    color: #1f2937;
    border: 1px solid #e5e7eb;
}

.btn-outline:hover {
    background: #f9fafb;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.modal.show { display: flex; }

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    animation: modalSlide 0.3s;
}

@keyframes modalSlide {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
}

.modal-header button {
    background: none;
    border: none;
    font-size: 26px;
    cursor: pointer;
    color: #6b7280;
}

.modal-body {
    padding: 20px;
    color: #4b5563;
}

.modal-details {
    background: #fef3c7;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    border: 1px solid #fbbf24;
    color: #78350f;
    font-size: 14px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 15px;
    }

    .stats-grid, .depts-grid {
        grid-template-columns: 1fr;
    }

    .modal-content {
        width: 95%;
    }
}
</style>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function closeAlert(id) {
    const alert = document.getElementById(id);
    if (alert) {
        alert.style.animation = 'slideOut 0.3s';
        setTimeout(() => alert.remove(), 300);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            if (alert.parentElement) {
                alert.style.animation = 'slideOut 0.3s';
                setTimeout(() => alert.remove(), 300);
            }
        }, 5000);
    });
});

function revoquerChef(deptId, chefNom, deptNom) {
    const modal = document.getElementById('modal');
    document.getElementById('modalTitle').textContent = 'Révoquer le chef de département';
    document.getElementById('modalMessage').textContent =
        `Êtes-vous sûr de vouloir révoquer ${chefNom} de son poste de chef du département ${deptNom} ?`;
    document.getElementById('modalDetails').innerHTML = `
        <strong>Conséquences :</strong>
        <ul style="margin: 10px 0 0 20px; padding: 0;">
            <li>Le département n'aura plus de chef</li>
            <li>L'enseignant reviendra au rôle "Enseignant"</li>
            <li>Vous devrez nommer un nouveau chef</li>
        </ul>
    `;

    document.getElementById('modalConfirm').onclick = function() {
        executeRevocation(deptId);
    };

    modal.classList.add('show');
}

function executeRevocation(deptId) {
    fetch(`/accounts/department-heads/${deptId}/revoke/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        closeModal();
        if (data.success) {
            showMessage(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showMessage(data.error || 'Erreur lors de la révocation', 'error');
        }
    })
    .catch(error => {
        closeModal();
        console.error('Error:', error);
        showMessage('Erreur de connexion', 'error');
    });
}

function closeModal() {
    document.getElementById('modal').classList.remove('show');
}

function showMessage(message, type) {
    const container = document.querySelector('.messages') || createMessageContainer();
    const id = 'msg-' + Date.now();

    container.insertAdjacentHTML('beforeend', `
        <div class="alert alert-${type}" id="${id}">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
            <button onclick="closeAlert('${id}')">&times;</button>
        </div>
    `);

    setTimeout(() => closeAlert(id), 5000);
}

function createMessageContainer() {
    const container = document.createElement('div');
    container.className = 'messages';
    document.querySelector('.dept-heads-page').insertBefore(
        container,
        document.querySelector('.stats-grid')
    );
    return container;
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
});
</script>
{% endblock %}